<!DOCTYPE html>
<html lang="uz">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Super Admin Panel - B2B Ta'lim Platformasi</title>
    <script>
        window.APP_CONFIG = {
            defaultUserId: 1,
            allowedUserIds: [1],
            lockRoleSwitcher: true
        };
    </script>
    <script src="https://cdn.tailwindcss.com"></script>
    <script src="https://cdn.jsdelivr.net/npm/chart.js"></script>
    <link rel="stylesheet" href="https://cdnjs.cloudflare.com/ajax/libs/font-awesome/6.4.0/css/all.min.css">
    <style>
        @import url('https://fonts.googleapis.com/css2?family=Inter:wght@300;400;500;600;700&display=swap');
        * {
            font-family: 'Inter', sans-serif;
        }
        /* Mobile Sidebar Overlay */
        .sidebar-overlay {
            display: none;
        }
        @media (max-width: 768px) {
            .sidebar-overlay {
                display: block;
                position: fixed;
                inset: 0;
                background-color: rgba(0, 0, 0, 0.5);
                z-index: 40;
                opacity: 0;
                visibility: hidden;
                transition: opacity 0.3s, visibility 0.3s;
            }
            .sidebar-overlay.active {
                opacity: 1;
                visibility: visible;
            }
            aside {
                position: fixed;
                left: -100%;
                top: 0;
                bottom: 0;
                z-index: 50;
                transition: left 0.3s ease;
            }
            aside.mobile-open {
                left: 0;
            }
            main {
                width: 100%;
            }
        }
        /* Chart containers for mobile */
        .chart-container {
            position: relative;
            width: 100%;
            height: 200px;
        }
        @media (min-width: 769px) {
            .chart-container {
                height: 220px;
            }
        }
        .chart-container-pie {
            position: relative;
            width: 100%;
            height: 280px;
        }
        @media (min-width: 769px) {
            .chart-container-pie {
                height: 350px;
            }
        }
        .chart-container-bar {
            position: relative;
            width: 100%;
            height: 220px;
        }
        @media (min-width: 769px) {
            .chart-container-bar {
                height: 280px;
            }
        }
        /* Custom Switch Styles */
        .status-switch {
            position: relative;
            display: inline-block;
            width: 56px;
            height: 26px;
        }
        .status-switch input {
            opacity: 0;
            width: 0;
            height: 0;
        }
        .status-slider {
            position: absolute;
            cursor: pointer;
            top: 0;
            left: 0;
            right: 0;
            bottom: 0;
            background-color: #ef4444;
            transition: .4s;
            border-radius: 34px;
        }
        .status-slider:before {
            position: absolute;
            content: "";
            height: 18px;
            width: 18px;
            left: 4px;
            bottom: 4px;
            background-color: white;
            transition: .4s;
            border-radius: 50%;
        }
        .status-switch input:checked + .status-slider {
            background-color: #3b82f6;
        }
        .status-switch input:checked + .status-slider:before {
            transform: translateX(30px);
        }
        .status-label {
            font-size: 11px;
            font-weight: 600;
            margin-left: 4px;
            min-width: 70px;
            display: inline-block;
        }
        .status-active {
            color: #1e40af;
        }
        .status-blocked {
            color: #dc2626;
        }
        .status-expired {
            color: #f59e0b;
        }
        /* Badge styles */
        .badge {
            display: inline-block;
            padding: 2px 8px;
            border-radius: 12px;
            font-size: 11px;
            font-weight: 600;
        }
        .badge-active {
            background-color: #dbeafe;
            color: #1e40af;
        }
        .badge-blocked {
            background-color: #fee2e2;
            color: #dc2626;
        }
        .badge-expired {
            background-color: #fef3c7;
            color: #d97706;
        }
        .badge-paid {
            background-color: #d1fae5;
            color: #065f46;
        }
        .badge-overdue {
            background-color: #fecaca;
            color: #991b1b;
        }
        .badge-demo {
            background-color: #e0e7ff;
            color: #3730a3;
        }
        /* Row highlighting */
        .admin-row {
            background-color: #f0f9ff;
        }
        .student-row {
            background-color: white;
        }
        .expiring-row {
            background-color: #fffbeb;
            border-left: 4px solid #f59e0b;
        }
        /* Animation for new elements */
        @keyframes fadeIn {
            from { opacity: 0; transform: translateY(10px); }
            to { opacity: 1; transform: translateY(0); }
        }
        .fade-in {
            animation: fadeIn 0.3s ease-out;
        }
        /* Countdown timer */
        .countdown {
            font-family: monospace;
            font-weight: bold;
            color: #dc2626;
        }
        /* Table row hover effects */
        .table-row-hover:hover {
            background-color: #f8fafc;
        }
    </style>
</head>
<body class="bg-gray-100">
    <!-- Mobile Sidebar Overlay -->
    <div class="sidebar-overlay" id="sidebarOverlay"></div>
    
    <div class="flex min-h-screen">
        <!-- Mobile Menu Button -->
        <button id="mobileMenuBtn" class="fixed top-4 left-4 z-30 lg:hidden bg-white p-2 rounded-lg shadow-md text-gray-700 hover:bg-gray-100">
            <i class="fas fa-bars text-xl"></i>
        </button>
        
        <!-- Sidebar -->
        <aside id="sidebar" class="w-64 bg-white border-r border-gray-200 flex flex-col">
            <div class="px-6 py-5 border-b border-gray-200 flex items-center justify-between">
                <div class="flex items-center space-x-3 cursor-pointer hover:bg-gray-50 rounded-lg p-2 -m-2 transition-colors flex-1" id="openProfileSettings">
                    <div class="w-10 h-10 rounded-full bg-blue-600 text-white flex items-center justify-center font-bold">SA</div>
                    <div>
                        <p class="text-sm text-gray-500">Super Admin Panel</p>
                        <p class="text-base font-semibold text-gray-800" id="profileName">Yoqubov Shehroz</p>
                    </div>
                </div>
                <!-- Mobile Close Button -->
                <button id="mobileCloseBtn" class="lg:hidden text-gray-500 hover:text-gray-700 p-2">
                    <i class="fas fa-times text-xl"></i>
                </button>
            </div>
            <nav class="flex-1 px-3 py-4 space-y-1" id="sidebarNav">
                <a href="#" data-target="dashboardSection" class="flex items-center space-x-3 px-3 py-2 rounded-lg bg-blue-600 text-white font-semibold">
                    <i class="fas fa-home"></i><span>Bosh sahifa</span>
                </a>
                <a href="#" data-target="schoolsSection" class="flex items-center space-x-3 px-3 py-2 rounded-lg text-gray-700 hover:bg-gray-100">
                    <i class="fas fa-school"></i><span>Maktablar</span>
                </a>
                <a href="#" data-target="usersSection" class="flex items-center space-x-3 px-3 py-2 rounded-lg text-gray-700 hover:bg-gray-100">
                    <i class="fas fa-users"></i><span>Foydalanuvchilar</span>
                </a>
                <a href="#" data-target="paymentsSection" class="flex items-center space-x-3 px-3 py-2 rounded-lg text-gray-700 hover:bg-gray-100">
                    <i class="fas fa-credit-card"></i><span>To'lovlar</span>
                </a>
                <a href="#" data-target="demoUsersSection" class="flex items-center space-x-3 px-3 py-2 rounded-lg text-gray-700 hover:bg-gray-100">
                    <i class="fas fa-user-clock"></i><span>Demo foydalanuvchilar</span>
                </a>
                <a href="#" data-target="expiringSection" class="flex items-center space-x-3 px-3 py-2 rounded-lg text-amber-600 hover:bg-amber-50">
                    <i class="fas fa-clock"></i><span>Muddat tugash</span>
                    <span class="ml-auto bg-red-100 text-red-800 text-xs font-bold px-2 py-1 rounded-full" id="expiringCount">0</span>
                </a>
            </nav>
            <div class="px-3 py-4 border-t border-gray-200">
                <button class="w-full flex items-center space-x-3 px-3 py-2 rounded-lg text-red-600 hover:bg-red-50" id="logoutBtn">
                    <i class="fas fa-sign-out-alt"></i><span>Chiqish</span>
                </button>
            </div>
        </aside>

        <!-- Main -->
        <main class="flex-1 lg:ml-0">
            <header id="topSection" class="min-h-16 bg-white border-b border-gray-200 flex items-center px-4 md:px-6 pt-16 lg:pt-0 pb-3 lg:pb-0">
                <div class="w-full">
                    <p class="text-xs text-gray-500 truncate" id="breadcrumb">Bosh sahifa / Admin Dashboard</p>
                    <h1 class="text-base md:text-lg lg:text-xl font-semibold text-gray-800 truncate" id="pageTitle">Admin Dashboard</h1>
                </div>
            </header>

            <div class="p-3 md:p-6 space-y-4 md:space-y-6">
                <!-- Dashboard Section -->
                <div id="dashboardSection" class="section-block space-y-4 md:space-y-6">
                    <!-- KPI Cards -->
                    <div class="grid grid-cols-1 sm:grid-cols-2 xl:grid-cols-4 gap-3 md:gap-4">
                        <div class="bg-white rounded-xl shadow-sm border border-gray-200 p-3 md:p-4 flex items-center justify-between fade-in">
                            <div class="flex-1">
                                <p class="text-xs text-gray-500">Umumiy daromad</p>
                                <p class="text-base md:text-lg font-semibold text-gray-800" id="totalRevenue">0 so'm</p>
                            </div>
                            <div class="text-blue-600 text-lg md:text-xl ml-2"><i class="fas fa-coins"></i></div>
                        </div>
                        <div class="bg-white rounded-xl shadow-sm border border-gray-200 p-3 md:p-4 flex items-center justify-between fade-in">
                            <div class="flex-1">
                                <p class="text-xs text-gray-500">Maktablar soni</p>
                                <p class="text-base md:text-lg font-semibold text-gray-800" id="schoolsCount">0</p>
                            </div>
                            <div class="text-blue-600 text-lg md:text-xl ml-2"><i class="fas fa-school"></i></div>
                        </div>
                        <div class="bg-white rounded-xl shadow-sm border border-gray-200 p-3 md:p-4 flex items-center justify-between fade-in">
                            <div class="flex-1">
                                <p class="text-xs text-gray-500">Foydalanuvchilar soni</p>
                                <p class="text-base md:text-lg font-semibold text-gray-800" id="usersCount">0</p>
                            </div>
                            <div class="text-purple-600 text-lg md:text-xl ml-2"><i class="fas fa-users"></i></div>
                        </div>
                        <div class="bg-white rounded-xl shadow-sm border border-gray-200 p-3 md:p-4 flex items-center justify-between fade-in">
                            <div class="flex-1">
                                <p class="text-xs text-gray-500">Bugungi to'lovlar</p>
                                <p class="text-base md:text-lg font-semibold text-gray-800" id="todayPayments">0 so'm</p>
                            </div>
                            <div class="text-green-600 text-lg md:text-xl ml-2"><i class="fas fa-money-bill-wave"></i></div>
                        </div>
                    </div>

                    <!-- Charts Row -->
                    <div class="grid grid-cols-1 lg:grid-cols-2 gap-3 md:gap-4">
                        <div class="bg-white rounded-xl shadow-sm border border-gray-200 p-3 md:p-4">
                            <h3 class="text-sm md:text-base font-semibold text-gray-800 mb-2 md:mb-3">Oylik daromad diagrammasi</h3>
                            <div class="chart-container">
                                <canvas id="revenueChart"></canvas>
                            </div>
                        </div>
                        <div class="bg-white rounded-xl shadow-sm border border-gray-200 p-3 md:p-4">
                            <h3 class="text-sm md:text-base font-semibold text-gray-800 mb-2 md:mb-3">Obuna turlari taqsimoti</h3>
                            <div class="chart-container-pie flex justify-center items-center">
                                <canvas id="subscriptionChart"></canvas>
                            </div>
                        </div>
                    </div>

                    <!-- Top schools and expiring soon -->
                    <div class="grid grid-cols-1 lg:grid-cols-2 gap-3 md:gap-4">
                        <div class="bg-white rounded-xl shadow-sm border border-gray-200 p-3 md:p-4">
                            <h3 class="text-sm md:text-base font-semibold text-gray-800 mb-2 md:mb-3 flex items-center space-x-2">
                                <span class="text-amber-500"><i class="fas fa-trophy"></i></span>
                                <span>TOP-5 maktablar (To'lovlar bo'yicha)</span>
                            </h3>
                            <div class="chart-container-bar">
                                <canvas id="topSchoolsChart"></canvas>
                            </div>
                        </div>
                        
                        <div class="bg-white rounded-xl shadow-sm border border-gray-200 p-3 md:p-4">
                            <h3 class="text-sm md:text-base font-semibold text-gray-800 mb-2 md:mb-3 flex items-center space-x-2">
                                <span class="text-red-500"><i class="fas fa-exclamation-triangle"></i></span>
                                <span>Tez orada muddati tugaydigan maktablar</span>
                            </h3>
                            <div class="overflow-y-auto max-h-64">
                                <table class="min-w-full divide-y divide-gray-200 text-xs">
                                    <thead class="bg-gray-50">
                                        <tr>
                                            <th class="px-3 py-2 text-left">Maktab nomi</th>
                                            <th class="px-3 py-2 text-left">Qolgan kunlar</th>
                                            <th class="px-3 py-2 text-left">Holati</th>
                                        </tr>
                                    </thead>
                                    <tbody class="divide-y divide-gray-100" id="expiringSoonList">
                                        <!-- Dynamic content -->
                                    </tbody>
                                </table>
                            </div>
                        </div>
                    </div>
                </div>

                <!-- Schools Section -->
                <div id="schoolsSection" class="section-block bg-white rounded-xl shadow-sm border border-gray-200 p-3 md:p-4 hidden">
                    <div class="flex flex-col sm:flex-row sm:items-center sm:justify-between mb-3 md:mb-4 gap-3">
                        <div>
                            <p class="text-xs text-gray-500">Bosh sahifa / Maktablar</p>
                            <h3 class="text-base md:text-lg font-semibold text-gray-800">Maktablar ro'yxati</h3>
                        </div>
                        <div class="flex flex-col sm:flex-row gap-2">
                            <div class="relative">
                                <input type="text" id="schoolSearch" placeholder="Qidirish..." class="w-full sm:w-48 px-4 py-2 border border-gray-300 rounded-lg focus:outline-none focus:ring-2 focus:ring-blue-500 text-sm">
                                <i class="fas fa-search absolute right-3 top-2.5 text-gray-400"></i>
                            </div>
                            <button id="openCreateSchoolBtn" class="px-3 py-2 bg-blue-600 text-white rounded-lg text-sm hover:bg-blue-700 whitespace-nowrap"><i class="fas fa-plus mr-2"></i>Yangi maktab</button>
                        </div>
                    </div>
                    
                    <!-- Filters -->
                    <div class="flex flex-wrap gap-2 mb-4">
                        <select id="schoolStatusFilter" class="px-3 py-2 border border-gray-300 rounded-lg text-sm">
                            <option value="">Barcha holatlar</option>
                            <option value="active">Aktiv</option>
                            <option value="blocked">Bloklangan</option>
                            <option value="expired">Muddati tugagan</option>
                        </select>
                        <select id="schoolSubscriptionFilter" class="px-3 py-2 border border-gray-300 rounded-lg text-sm">
                            <option value="">Barcha obuna turlari</option>
                            <option value="monthly">Oyli</option>
                            <option value="yearly">Yillik</option>
                        </select>
                        <input type="date" id="schoolDateFilter" class="px-3 py-2 border border-gray-300 rounded-lg text-sm">
                        <button id="clearSchoolFilters" class="px-3 py-2 border border-gray-300 rounded-lg text-gray-700 text-sm hover:bg-gray-50">Filterni tozalash</button>
                    </div>
                    
                    <div class="overflow-x-auto -mx-3 md:mx-0">
                        <table class="min-w-full divide-y divide-gray-200 text-xs md:text-sm">
                            <thead class="bg-gray-50 text-gray-700">
                                <tr>
                                    <th class="px-2 md:px-4 py-2 text-left whitespace-nowrap cursor-pointer sort-header" data-sort="id">ID <i class="fas fa-sort ml-1"></i></th>
                                    <th class="px-2 md:px-4 py-2 text-left whitespace-nowrap cursor-pointer sort-header" data-sort="name">Maktab nomi <i class="fas fa-sort ml-1"></i></th>
                                    <th class="px-2 md:px-4 py-2 text-left whitespace-nowrap">Telefon</th>
                                    <th class="px-2 md:px-4 py-2 text-left whitespace-nowrap">To'lov sanasi</th>
                                    <th class="px-2 md:px-4 py-2 text-left whitespace-nowrap">Tugash sanasi</th>
                                    <th class="px-2 md:px-4 py-2 text-left whitespace-nowrap">Obuna turi</th>
                                    <th class="px-2 md:px-4 py-2 text-left whitespace-nowrap">Status</th>
                                    <th class="px-2 md:px-4 py-2 text-left whitespace-nowrap">Amallar</th>
                                </tr>
                            </thead>
                            <tbody class="divide-y divide-gray-100" id="schoolsTableBody">
                                <!-- Dynamic content -->
                            </tbody>
                        </table>
                    </div>
                    <div class="flex flex-col sm:flex-row items-center justify-between mt-3 text-xs text-gray-600">
                        <p id="schoolsCountText">Jami 0 ta maktab</p>
                        <div class="flex items-center space-x-2 mt-2 sm:mt-0">
                            <div class="flex items-center space-x-1">
                                <button id="schoolPrevPage" class="px-2 py-1 border rounded text-gray-500 hover:bg-gray-100"><i class="fas fa-chevron-left"></i></button>
                                <span id="schoolCurrentPage" class="px-2">1</span>
                                <button id="schoolNextPage" class="px-2 py-1 border rounded text-gray-500 hover:bg-gray-100"><i class="fas fa-chevron-right"></i></button>
                            </div>
                            <select id="schoolPageSize" class="border rounded px-2 py-1 text-gray-700">
                                <option value="10">10 / sahifa</option>
                                <option value="25">25 / sahifa</option>
                                <option value="50">50 / sahifa</option>
                            </select>
                        </div>
                    </div>
                </div>

                <!-- Users Section -->
                <div id="usersSection" class="section-block bg-white rounded-xl shadow-sm border border-gray-200 p-3 md:p-4 hidden">
                    <div class="flex flex-col sm:flex-row sm:items-center sm:justify-between mb-3 md:mb-4 gap-3">
                        <div>
                            <p class="text-xs text-gray-500">Bosh sahifa / Foydalanuvchilar</p>
                            <h3 class="text-base md:text-lg font-semibold text-gray-800">Foydalanuvchilar ro'yxati</h3>
                        </div>
                        <div class="flex flex-col sm:flex-row gap-2">
                            <div class="relative">
                                <input type="text" id="userSearch" placeholder="Qidirish..." class="w-full sm:w-48 px-4 py-2 border border-gray-300 rounded-lg focus:outline-none focus:ring-2 focus:ring-blue-500 text-sm">
                                <i class="fas fa-search absolute right-3 top-2.5 text-gray-400"></i>
                            </div>
                            <button id="openCreateUserBtn" class="px-3 py-2 bg-blue-600 text-white rounded-lg text-sm hover:bg-blue-700 whitespace-nowrap"><i class="fas fa-plus mr-2"></i>Yangi foydalanuvchi</button>
                            <button id="openRandomStudentsBtn" class="px-3 py-2 bg-green-600 text-white rounded-lg text-sm hover:bg-green-700 whitespace-nowrap"><i class="fas fa-random mr-2"></i>Random studentlar</button>
                        </div>
                    </div>
                    
                    <!-- Filters -->
                    <div class="flex flex-wrap gap-2 mb-4">
                        <select id="userRoleFilter" class="px-3 py-2 border border-gray-300 rounded-lg text-sm">
                            <option value="">Barcha rollar</option>
                            <option value="admin">Admin</option>
                            <option value="student">Student</option>
                        </select>
                        <select id="userStatusFilter" class="px-3 py-2 border border-gray-300 rounded-lg text-sm">
                            <option value="">Barcha holatlar</option>
                            <option value="active">Aktiv</option>
                            <option value="blocked">Bloklangan</option>
                        </select>
                        <select id="userSchoolFilter" class="px-3 py-2 border border-gray-300 rounded-lg text-sm">
                            <option value="">Barcha maktablar</option>
                        </select>
                        <button id="clearUserFilters" class="px-3 py-2 border border-gray-300 rounded-lg text-gray-700 text-sm hover:bg-gray-50">Filterni tozalash</button>
                    </div>
                    
                    <div class="overflow-x-auto -mx-3 md:mx-0">
                        <table class="min-w-full divide-y divide-gray-200 text-xs md:text-sm">
                            <thead class="bg-gray-50 text-gray-700">
                                <tr>
                                    <th class="px-2 md:px-4 py-2 text-left whitespace-nowrap cursor-pointer sort-header" data-sort="id">ID <i class="fas fa-sort ml-1"></i></th>
                                    <th class="px-2 md:px-4 py-2 text-left whitespace-nowrap cursor-pointer sort-header" data-sort="name">Ism <i class="fas fa-sort ml-1"></i></th>
                                    <th class="px-2 md:px-4 py-2 text-left whitespace-nowrap">Telefon</th>
                                    <th class="px-2 md:px-4 py-2 text-left whitespace-nowrap">Parol</th>
                                    <th class="px-2 md:px-4 py-2 text-left whitespace-nowrap">Rol</th>
                                    <th class="px-2 md:px-4 py-2 text-left whitespace-nowrap">Maktab nomi</th>
                                    <th class="px-2 md:px-4 py-2 text-left whitespace-nowrap">Status</th>
                                    <th class="px-2 md:px-4 py-2 text-left whitespace-nowrap">Yaratilgan sana</th>
                                    <th class="px-2 md:px-4 py-2 text-left whitespace-nowrap">Amallar</th>
                                </tr>
                            </thead>
                            <tbody class="divide-y divide-gray-100" id="usersTableBody">
                                <!-- Dynamic content -->
                            </tbody>
                        </table>
                    </div>
                    <div class="flex flex-col sm:flex-row items-center justify-between mt-3 text-xs text-gray-600">
                        <p id="usersCountText">Jami 0 ta foydalanuvchi</p>
                        <div class="flex items-center space-x-2 mt-2 sm:mt-0">
                            <div class="flex items-center space-x-1">
                                <button id="userPrevPage" class="px-2 py-1 border rounded text-gray-500 hover:bg-gray-100"><i class="fas fa-chevron-left"></i></button>
                                <span id="userCurrentPage" class="px-2">1</span>
                                <button id="userNextPage" class="px-2 py-1 border rounded text-gray-500 hover:bg-gray-100"><i class="fas fa-chevron-right"></i></button>
                            </div>
                            <select id="userPageSize" class="border rounded px-2 py-1 text-gray-700">
                                <option value="10">10 / sahifa</option>
                                <option value="25">25 / sahifa</option>
                                <option value="50">50 / sahifa</option>
                            </select>
                        </div>
                    </div>
                </div>

                <!-- Payments Section -->
                <div id="paymentsSection" class="section-block bg-white rounded-xl shadow-sm border border-gray-200 p-3 md:p-4 hidden">
                    <div class="flex flex-col sm:flex-row sm:items-center sm:justify-between mb-3 md:mb-4 gap-3">
                        <div>
                            <p class="text-xs text-gray-500">Bosh sahifa / To'lovlar</p>
                            <h3 class="text-base md:text-lg font-semibold text-gray-800">To'lovlar ro'yxati</h3>
                        </div>
                        <div class="flex flex-col sm:flex-row gap-2">
                            <div class="relative">
                                <input type="text" id="paymentSearch" placeholder="Qidirish..." class="w-full sm:w-48 px-4 py-2 border border-gray-300 rounded-lg focus:outline-none focus:ring-2 focus:ring-blue-500 text-sm">
                                <i class="fas fa-search absolute right-3 top-2.5 text-gray-400"></i>
                            </div>
                            <button id="openCreatePaymentBtn" class="px-3 py-2 bg-blue-600 text-white rounded-lg text-sm hover:bg-blue-700 whitespace-nowrap"><i class="fas fa-plus mr-2"></i>Yangi to'lov</button>
                        </div>
                    </div>
                    
                    <!-- Filters -->
                    <div class="flex flex-wrap gap-2 mb-4">
                        <select id="paymentStatusFilter" class="px-3 py-2 border border-gray-300 rounded-lg text-sm">
                            <option value="">Barcha holatlar</option>
                            <option value="paid">To'langan</option>
                            <option value="overdue">Muddati o'tgan</option>
                        </select>
                        <select id="paymentSubscriptionFilter" class="px-3 py-2 border border-gray-300 rounded-lg text-sm">
                            <option value="">Barcha obuna turlari</option>
                            <option value="monthly">Oyli</option>
                            <option value="yearly">Yillik</option>
                        </select>
                        <select id="paymentSchoolFilter" class="px-3 py-2 border border-gray-300 rounded-lg text-sm">
                            <option value="">Barcha maktablar</option>
                        </select>
                        <div class="flex items-center gap-2">
                            <input type="date" id="paymentDateFrom" class="px-3 py-2 border border-gray-300 rounded-lg text-sm">
                            <span>-</span>
                            <input type="date" id="paymentDateTo" class="px-3 py-2 border border-gray-300 rounded-lg text-sm">
                        </div>
                        <button id="clearPaymentFilters" class="px-3 py-2 border border-gray-300 rounded-lg text-gray-700 text-sm hover:bg-gray-50">Filterni tozalash</button>
                    </div>
                    
                    <div class="overflow-x-auto -mx-3 md:mx-0">
                        <table class="min-w-full divide-y divide-gray-200 text-xs md:text-sm">
                            <thead class="bg-gray-50 text-gray-700">
                                <tr>
                                    <th class="px-2 md:px-4 py-2 text-left whitespace-nowrap cursor-pointer sort-header" data-sort="id">ID <i class="fas fa-sort ml-1"></i></th>
                                    <th class="px-2 md:px-4 py-2 text-left whitespace-nowrap cursor-pointer sort-header" data-sort="school">Maktab nomi <i class="fas fa-sort ml-1"></i></th>
                                    <th class="px-2 md:px-4 py-2 text-left whitespace-nowrap cursor-pointer sort-header" data-sort="amount">Summa <i class="fas fa-sort ml-1"></i></th>
                                    <th class="px-2 md:px-4 py-2 text-left whitespace-nowrap cursor-pointer sort-header" data-sort="date">To'lov sanasi <i class="fas fa-sort ml-1"></i></th>
                                    <th class="px-2 md:px-4 py-2 text-left whitespace-nowrap">Obuna turi</th>
                                    <th class="px-2 md:px-4 py-2 text-left whitespace-nowrap cursor-pointer sort-header" data-sort="expiry">Tugash sanasi <i class="fas fa-sort ml-1"></i></th>
                                    <th class="px-2 md:px-4 py-2 text-left whitespace-nowrap">Status</th>
                                    <th class="px-2 md:px-4 py-2 text-left whitespace-nowrap">Amallar</th>
                                </tr>
                            </thead>
                            <tbody class="divide-y divide-gray-100" id="paymentsTableBody">
                                <!-- Dynamic content -->
                            </tbody>
                        </table>
                    </div>
                    <div class="flex flex-col sm:flex-row items-center justify-between mt-3 text-xs text-gray-600">
                        <div>
                            <p id="paymentsCountText">Jami 0 ta to'lov</p>
                            <p class="text-green-600 font-semibold" id="totalPaymentsAmount">Umumiy summa: 0 so'm</p>
                        </div>
                        <div class="flex items-center space-x-2 mt-2 sm:mt-0">
                            <div class="flex items-center space-x-1">
                                <button id="paymentPrevPage" class="px-2 py-1 border rounded text-gray-500 hover:bg-gray-100"><i class="fas fa-chevron-left"></i></button>
                                <span id="paymentCurrentPage" class="px-2">1</span>
                                <button id="paymentNextPage" class="px-2 py-1 border rounded text-gray-500 hover:bg-gray-100"><i class="fas fa-chevron-right"></i></button>
                            </div>
                            <select id="paymentPageSize" class="border rounded px-2 py-1 text-gray-700">
                                <option value="10">10 / sahifa</option>
                                <option value="25">25 / sahifa</option>
                                <option value="50">50 / sahifa</option>
                            </select>
                        </div>
                    </div>
                </div>

                <!-- Demo Users Section -->
                <div id="demoUsersSection" class="section-block bg-white rounded-xl shadow-sm border border-gray-200 p-3 md:p-4 hidden">
                    <div class="flex flex-col sm:flex-row sm:items-center sm:justify-between mb-3 md:mb-4 gap-3">
                        <div>
                            <p class="text-xs text-gray-500">Bosh sahifa / Demo foydalanuvchilar</p>
                            <h3 class="text-base md:text-lg font-semibold text-gray-800">Demo foydalanuvchilar ro'yxati</h3>
                        </div>
                        <div class="flex flex-col sm:flex-row gap-2">
                            <div class="relative">
                                <input type="text" id="demoUserSearch" placeholder="Qidirish..." class="w-full sm:w-48 px-4 py-2 border border-gray-300 rounded-lg focus:outline-none focus:ring-2 focus:ring-blue-500 text-sm">
                                <i class="fas fa-search absolute right-3 top-2.5 text-gray-400"></i>
                            </div>
                            <button id="openCreateDemoUserBtn" class="px-3 py-2 bg-purple-600 text-white rounded-lg text-sm hover:bg-purple-700 whitespace-nowrap"><i class="fas fa-plus mr-2"></i>Yangi demo foydalanuvchi</button>
                        </div>
                    </div>
                    
                    <!-- Demo info -->
                    <div class="mb-4 p-3 bg-blue-50 rounded-lg">
                        <p class="text-sm text-blue-800"><i class="fas fa-info-circle mr-2"></i>Demo foydalanuvchilar 7 kunlik muddatga beriladi. Muddat o'tgach, ular avtomatik ravishda bloklanadi.</p>
                    </div>
                    
                    <div class="overflow-x-auto -mx-3 md:mx-0">
                        <table class="min-w-full divide-y divide-gray-200 text-xs md:text-sm">
                            <thead class="bg-gray-50 text-gray-700">
                                <tr>
                                    <th class="px-2 md:px-4 py-2 text-left whitespace-nowrap cursor-pointer sort-header" data-sort="id">ID <i class="fas fa-sort ml-1"></i></th>
                                    <th class="px-2 md:px-4 py-2 text-left whitespace-nowrap cursor-pointer sort-header" data-sort="name">Ism <i class="fas fa-sort ml-1"></i></th>
                                    <th class="px-2 md:px-4 py-2 text-left whitespace-nowrap">Telefon</th>
                                    <th class="px-2 md:px-4 py-2 text-left whitespace-nowrap">Parol</th>
                                    <th class="px-2 md:px-4 py-2 text-left whitespace-nowrap">Yaratilgan sana</th>
                                    <th class="px-2 md:px-4 py-2 text-left whitespace-nowrap">Tugash sanasi</th>
                                    <th class="px-2 md:px-4 py-2 text-left whitespace-nowrap">Qolgan kunlar</th>
                                    <th class="px-2 md:px-4 py-2 text-left whitespace-nowrap">Status</th>
                                    <th class="px-2 md:px-4 py-2 text-left whitespace-nowrap">Amallar</th>
                                </tr>
                            </thead>
                            <tbody class="divide-y divide-gray-100" id="demoUsersTableBody">
                                <!-- Dynamic content -->
                            </tbody>
                        </table>
                    </div>
                    <div class="flex flex-col sm:flex-row items-center justify-between mt-3 text-xs text-gray-600">
                        <p id="demoUsersCountText">Jami 0 ta demo foydalanuvchi</p>
                        <div class="flex items-center space-x-2 mt-2 sm:mt-0">
                            <div class="flex items-center space-x-1">
                                <button id="demoUserPrevPage" class="px-2 py-1 border rounded text-gray-500 hover:bg-gray-100"><i class="fas fa-chevron-left"></i></button>
                                <span id="demoUserCurrentPage" class="px-2">1</span>
                                <button id="demoUserNextPage" class="px-2 py-1 border rounded text-gray-500 hover:bg-gray-100"><i class="fas fa-chevron-right"></i></button>
                            </div>
                            <select id="demoUserPageSize" class="border rounded px-2 py-1 text-gray-700">
                                <option value="10">10 / sahifa</option>
                                <option value="25">25 / sahifa</option>
                                <option value="50">50 / sahifa</option>
                            </select>
                        </div>
                    </div>
                </div>

                <!-- Expiring Soon Section -->
                <div id="expiringSection" class="section-block bg-white rounded-xl shadow-sm border border-gray-200 p-3 md:p-4 hidden">
                    <div class="flex flex-col sm:flex-row sm:items-center sm:justify-between mb-3 md:mb-4 gap-3">
                        <div>
                            <p class="text-xs text-gray-500">Bosh sahifa / Muddat tugash</p>
                            <h3 class="text-base md:text-lg font-semibold text-gray-800 flex items-center">
                                <span class="text-red-500 mr-2"><i class="fas fa-exclamation-triangle"></i></span>
                                <span>Muddat tugash arifasidagi maktablar</span>
                            </h3>
                        </div>
                        <div class="flex items-center gap-2">
                            <span class="text-sm text-gray-600">Ko'rsatish:</span>
                            <select id="expiringDaysFilter" class="px-3 py-2 border border-gray-300 rounded-lg text-sm">
                                <option value="7">7 kun ichida</option>
                                <option value="15">15 kun ichida</option>
                                <option value="30">30 kun ichida</option>
                            </select>
                        </div>
                    </div>
                    
                    <div class="mb-4 p-3 bg-red-50 rounded-lg">
                        <p class="text-sm text-red-800"><i class="fas fa-exclamation-circle mr-2"></i>Ushbu ro'yxatda muddati tez orada tugaydigan maktablar ko'rsatilgan. Iltimos, ular bilan bog'laning va to'lovni amalga oshirishlarini so'rang.</p>
                    </div>
                    
                    <div class="overflow-x-auto -mx-3 md:mx-0">
                        <table class="min-w-full divide-y divide-gray-200 text-xs md:text-sm">
                            <thead class="bg-gray-50 text-gray-700">
                                <tr>
                                    <th class="px-2 md:px-4 py-2 text-left whitespace-nowrap">ID</th>
                                    <th class="px-2 md:px-4 py-2 text-left whitespace-nowrap">Maktab nomi</th>
                                    <th class="px-2 md:px-4 py-2 text-left whitespace-nowrap">Telefon</th>
                                    <th class="px-2 md:px-4 py-2 text-left whitespace-nowrap">Oxirgi to'lov</th>
                                    <th class="px-2 md:px-4 py-2 text-left whitespace-nowrap">Tugash sanasi</th>
                                    <th class="px-2 md:px-4 py-2 text-left whitespace-nowrap">Qolgan kunlar</th>
                                    <th class="px-2 md:px-4 py-2 text-left whitespace-nowrap">Obuna turi</th>
                                    <th class="px-2 md:px-4 py-2 text-left whitespace-nowrap">Amallar</th>
                                </tr>
                            </thead>
                            <tbody class="divide-y divide-gray-100" id="expiringTableBody">
                                <!-- Dynamic content -->
                            </tbody>
                        </table>
                    </div>
                    <div class="flex items-center justify-between mt-3 text-xs text-gray-600">
                        <p id="expiringCountText">Jami 0 ta maktab</p>
                        <div class="flex items-center space-x-2">
                            <button id="sendRemindersBtn" class="px-3 py-2 bg-amber-500 text-white rounded-lg text-sm hover:bg-amber-600"><i class="fas fa-bell mr-2"></i>Xabar yuborish</button>
                        </div>
                    </div>
                </div>
            </div>
        </main>
    </div>

    <!-- MODALS -->
    
    <!-- Create School Modal -->
    <div id="createSchoolOverlay" class="fixed inset-0 bg-black bg-opacity-50 hidden items-center justify-center z-50 p-4">
        <div class="bg-white rounded-xl shadow-2xl w-full max-w-lg p-4 md:p-6 max-h-[90vh] overflow-y-auto">
            <div class="flex items-center justify-between mb-4">
                <div>
                    <p class="text-xs text-gray-500">Yangi maktab yaratish</p>
                    <h3 class="text-xl font-semibold text-gray-800">Yangi maktab</h3>
                </div>
                <button id="closeCreateSchool" class="text-gray-500 hover:text-gray-700"><i class="fas fa-times"></i></button>
            </div>
            <form id="createSchoolForm" class="space-y-4">
                <div>
                    <label class="block text-sm font-medium text-gray-700 mb-1">Maktab nomi *</label>
                    <input type="text" id="createSchoolName" required class="w-full px-4 py-2 border border-gray-300 rounded-lg focus:outline-none focus:ring-2 focus:ring-blue-500">
                </div>
                <div>
                    <label class="block text-sm font-medium text-gray-700 mb-1">Telefon *</label>
                    <input type="tel" id="createSchoolPhone" required pattern="^\+998[0-9]{9}$" class="w-full px-4 py-2 border border-gray-300 rounded-lg focus:outline-none focus:ring-2 focus:ring-blue-500" placeholder="+998901234567">
                    <p class="text-xs text-gray-500 mt-1">Format: +998901234567</p>
                </div>
                <div class="grid grid-cols-1 md:grid-cols-2 gap-4">
                    <div>
                        <label class="block text-sm font-medium text-gray-700 mb-1">To'lov sanasi *</label>
                        <input type="date" id="createSchoolPaymentDate" required class="w-full px-4 py-2 border border-gray-300 rounded-lg focus:outline-none focus:ring-2 focus:ring-blue-500">
                    </div>
                    <div>
                        <label class="block text-sm font-medium text-gray-700 mb-1">Obuna turi *</label>
                        <select id="createSchoolSubscriptionType" required class="w-full px-4 py-2 border border-gray-300 rounded-lg focus:outline-none focus:ring-2 focus:ring-blue-500">
                            <option value="monthly">Oyli</option>
                            <option value="yearly">Yillik</option>
                        </select>
                    </div>
                </div>
                <div>
                    <label class="block text-sm font-medium text-gray-700 mb-1">Tugash sanasi</label>
                    <input type="date" id="createSchoolExpiryDate" readonly class="w-full px-4 py-2 border border-gray-300 rounded-lg bg-gray-50">
                    <p class="text-xs text-gray-500 mt-1">To'lov sanasi va obuna turidan avtomatik hisoblanadi</p>
                </div>
                <div>
                    <label class="block text-sm font-medium text-gray-700 mb-1">Status</label>
                    <div class="flex items-center mt-2">
                        <label class="status-switch">
                            <input type="checkbox" id="createSchoolStatusToggle" checked>
                            <span class="status-slider"></span>
                        </label>
                        <span id="createSchoolStatusLabel" class="status-label status-active ml-2">Aktiv</span>
                    </div>
                </div>
                <div class="flex items-center justify-end space-x-3 pt-2">
                    <button type="button" id="cancelCreateSchool" class="px-4 py-2 border border-gray-300 rounded-lg text-gray-700 hover:bg-gray-50">Bekor qilish</button>
                    <button type="submit" class="px-4 py-2 bg-blue-600 text-white rounded-lg hover:bg-blue-700">Yaratish</button>
                </div>
            </form>
        </div>
    </div>

    <!-- Edit School Modal -->
    <div id="editSchoolOverlay" class="fixed inset-0 bg-black bg-opacity-50 hidden items-center justify-center z-50 p-4">
        <div class="bg-white rounded-xl shadow-2xl w-full max-w-lg p-4 md:p-6 max-h-[90vh] overflow-y-auto">
            <div class="flex items-center justify-between mb-4">
                <div>
                    <p class="text-xs text-gray-500">Maktab ma'lumotlarini tahrirlash</p>
                    <h3 class="text-xl font-semibold text-gray-800">Maktabni tahrirlash</h3>
                </div>
                <button id="closeEditSchool" class="text-gray-500 hover:text-gray-700"><i class="fas fa-times"></i></button>
            </div>
            <form id="editSchoolForm" class="space-y-4">
                <input type="hidden" id="editSchoolId">
                <div>
                    <label class="block text-sm font-medium text-gray-700 mb-1">Maktab nomi *</label>
                    <input type="text" id="editSchoolName" required class="w-full px-4 py-2 border border-gray-300 rounded-lg focus:outline-none focus:ring-2 focus:ring-blue-500">
                </div>
                <div>
                    <label class="block text-sm font-medium text-gray-700 mb-1">Telefon *</label>
                    <input type="tel" id="editSchoolPhone" required pattern="^\+998[0-9]{9}$" class="w-full px-4 py-2 border border-gray-300 rounded-lg focus:outline-none focus:ring-2 focus:ring-blue-500">
                </div>
                <div class="grid grid-cols-1 md:grid-cols-2 gap-4">
                    <div>
                        <label class="block text-sm font-medium text-gray-700 mb-1">To'lov sanasi *</label>
                        <input type="date" id="editSchoolPaymentDate" required class="w-full px-4 py-2 border border-gray-300 rounded-lg focus:outline-none focus:ring-2 focus:ring-blue-500">
                    </div>
                    <div>
                        <label class="block text-sm font-medium text-gray-700 mb-1">Obuna turi *</label>
                        <select id="editSchoolSubscriptionType" required class="w-full px-4 py-2 border border-gray-300 rounded-lg focus:outline-none focus:ring-2 focus:ring-blue-500">
                            <option value="monthly">Oyli</option>
                            <option value="yearly">Yillik</option>
                        </select>
                    </div>
                </div>
                <div>
                    <label class="block text-sm font-medium text-gray-700 mb-1">Tugash sanasi</label>
                    <input type="date" id="editSchoolExpiryDate" readonly class="w-full px-4 py-2 border border-gray-300 rounded-lg bg-gray-50">
                </div>
                <div>
                    <label class="block text-sm font-medium text-gray-700 mb-1">Status</label>
                    <div class="flex items-center mt-2">
                        <label class="status-switch">
                            <input type="checkbox" id="editSchoolStatusToggle">
                            <span class="status-slider"></span>
                        </label>
                        <span id="editSchoolStatusLabel" class="status-label ml-2">Aktiv</span>
                    </div>
                </div>
                <div class="flex items-center justify-end space-x-3 pt-2">
                    <button type="button" id="cancelEditSchool" class="px-4 py-2 border border-gray-300 rounded-lg text-gray-700 hover:bg-gray-50">Bekor qilish</button>
                    <button type="submit" class="px-4 py-2 bg-blue-600 text-white rounded-lg hover:bg-blue-700">Saqlash</button>
                </div>
            </form>
        </div>
    </div>

    <!-- School Details Modal -->
    <div id="schoolDetailsOverlay" class="fixed inset-0 bg-black bg-opacity-50 hidden items-center justify-center z-50 p-4">
        <div class="bg-white rounded-xl shadow-2xl w-full max-w-4xl p-4 md:p-6 max-h-[90vh] overflow-y-auto">
            <div class="flex items-center justify-between mb-4">
                <div>
                    <p class="text-xs text-gray-500">Maktab to'liq ma'lumotlari</p>
                    <h3 class="text-xl font-semibold text-gray-800" id="schoolDetailsTitle">Maktab ma'lumotlari</h3>
                </div>
                <button id="closeSchoolDetails" class="text-gray-500 hover:text-gray-700"><i class="fas fa-times"></i></button>
            </div>
            
            <div class="grid grid-cols-1 md:grid-cols-2 gap-6">
                <!-- School Info -->
                <div>
                    <h4 class="text-lg font-semibold text-gray-800 mb-3">Maktab ma'lumotlari</h4>
                    <div class="space-y-3">
                        <div>
                            <p class="text-sm text-gray-500">Maktab nomi</p>
                            <p class="text-base font-medium text-gray-800" id="detailSchoolName">-</p>
                        </div>
                        <div>
                            <p class="text-sm text-gray-500">Telefon</p>
                            <p class="text-base font-medium text-gray-800" id="detailSchoolPhone">-</p>
                        </div>
                        <div>
                            <p class="text-sm text-gray-500">To'lov sanasi</p>
                            <p class="text-base font-medium text-gray-800" id="detailPaymentDate">-</p>
                        </div>
                        <div>
                            <p class="text-sm text-gray-500">Tugash sanasi</p>
                            <p class="text-base font-medium text-gray-800" id="detailExpiryDate">-</p>
                        </div>
                        <div>
                            <p class="text-sm text-gray-500">Obuna turi</p>
                            <p class="text-base font-medium text-gray-800" id="detailSubscriptionType">-</p>
                        </div>
                        <div>
                            <p class="text-sm text-gray-500">Status</p>
                            <p class="text-base font-medium" id="detailSchoolStatus">-</p>
                        </div>
                    </div>
                </div>
                
                <!-- Admin Info -->
                <div>
                    <h4 class="text-lg font-semibold text-gray-800 mb-3">Admin ma'lumotlari</h4>
                    <div id="schoolAdminInfo">
                        <p class="text-gray-500">Bu maktab uchun admin topilmadi</p>
                    </div>
                </div>
            </div>
            
            <!-- Students List -->
            <div class="mt-6">
                <h4 class="text-lg font-semibold text-gray-800 mb-3">Studentlar ro'yxati</h4>
                <div class="overflow-x-auto">
                    <table class="min-w-full divide-y divide-gray-200 text-xs">
                        <thead class="bg-gray-50">
                            <tr>
                                <th class="px-3 py-2 text-left">ID</th>
                                <th class="px-3 py-2 text-left">Ism</th>
                                <th class="px-3 py-2 text-left">Telefon</th>
                                <th class="px-3 py-2 text-left">Status</th>
                                <th class="px-3 py-2 text-left">Yaratilgan sana</th>
                            </tr>
                        </thead>
                        <tbody class="divide-y divide-gray-100" id="schoolStudentsList">
                            <!-- Dynamic content -->
                        </tbody>
                    </table>
                </div>
                <p class="text-sm text-gray-500 mt-2" id="schoolStudentsCount">Jami 0 ta student</p>
            </div>
            
            <div class="flex items-center justify-end space-x-3 pt-4">
                <button type="button" id="closeSchoolDetailsBtn" class="px-4 py-2 border border-gray-300 rounded-lg text-gray-700 hover:bg-gray-50">Yopish</button>
            </div>
        </div>
    </div>

    <!-- Create User Modal -->
    <div id="createUserOverlay" class="fixed inset-0 bg-black bg-opacity-50 hidden items-center justify-center z-50 p-4">
        <div class="bg-white rounded-xl shadow-2xl w-full max-w-lg p-4 md:p-6 max-h-[90vh] overflow-y-auto">
            <div class="flex items-center justify-between mb-4">
                <div>
                    <p class="text-xs text-gray-500">Yangi foydalanuvchi yaratish</p>
                    <h3 class="text-xl font-semibold text-gray-800">Yangi foydalanuvchi</h3>
                </div>
                <button id="closeCreateUser" class="text-gray-500 hover:text-gray-700"><i class="fas fa-times"></i></button>
            </div>
            <form id="createUserForm" class="space-y-4">
                <div>
                    <label class="block text-sm font-medium text-gray-700 mb-1">Ism *</label>
                    <input type="text" id="createUserName" required class="w-full px-4 py-2 border border-gray-300 rounded-lg focus:outline-none focus:ring-2 focus:ring-blue-500">
                </div>
                <div>
                    <label class="block text-sm font-medium text-gray-700 mb-1">Telefon *</label>
                    <input type="tel" id="createUserPhone" required pattern="^\+998[0-9]{9}$" class="w-full px-4 py-2 border border-gray-300 rounded-lg focus:outline-none focus:ring-2 focus:ring-blue-500" placeholder="+998901234567">
                </div>
                <div>
                    <label class="block text-sm font-medium text-gray-700 mb-1">Parol *</label>
                    <input type="text" id="createUserPassword" required class="w-full px-4 py-2 border border-gray-300 rounded-lg focus:outline-none focus:ring-2 focus:ring-blue-500">
                </div>
                <div>
                    <label class="block text-sm font-medium text-gray-700 mb-1">Rol *</label>
                    <select id="createUserRole" required class="w-full px-4 py-2 border border-gray-300 rounded-lg focus:outline-none focus:ring-2 focus:ring-blue-500">
                        <option value="">Tanlang</option>
                        <option value="admin">Admin</option>
                        <option value="student">Student</option>
                    </select>
                </div>
                <div id="createUserSchoolField" class="hidden">
                    <label class="block text-sm font-medium text-gray-700 mb-1">Maktab nomi *</label>
                    <select id="createUserSchool" class="w-full px-4 py-2 border border-gray-300 rounded-lg focus:outline-none focus:ring-2 focus:ring-blue-500">
                        <option value="">Maktab tanlang</option>
                    </select>
                </div>
                <div>
                    <label class="block text-sm font-medium text-gray-700 mb-1">Status</label>
                    <div class="flex items-center mt-2">
                        <label class="status-switch">
                            <input type="checkbox" id="createUserStatusToggle" checked>
                            <span class="status-slider"></span>
                        </label>
                        <span id="createUserStatusLabel" class="status-label status-active ml-2">Aktiv</span>
                    </div>
                </div>
                <div class="flex items-center justify-end space-x-3 pt-2">
                    <button type="button" id="cancelCreateUser" class="px-4 py-2 border border-gray-300 rounded-lg text-gray-700 hover:bg-gray-50">Bekor qilish</button>
                    <button type="submit" class="px-4 py-2 bg-blue-600 text-white rounded-lg hover:bg-blue-700">Yaratish</button>
                </div>
            </form>
        </div>
    </div>

    <!-- Random Students Modal -->
    <div id="randomStudentsOverlay" class="fixed inset-0 bg-black bg-opacity-50 hidden items-center justify-center z-50 p-4">
        <div class="bg-white rounded-xl shadow-2xl w-full max-w-lg p-4 md:p-6 max-h-[90vh] overflow-y-auto">
            <div class="flex items-center justify-between mb-4">
                <div>
                    <p class="text-xs text-gray-500">Random studentlar yaratish</p>
                    <h3 class="text-xl font-semibold text-gray-800">Random studentlar yaratish</h3>
                </div>
                <button id="closeRandomStudents" class="text-gray-500 hover:text-gray-700"><i class="fas fa-times"></i></button>
            </div>
            <form id="randomStudentsForm" class="space-y-4">
                <div>
                    <label class="block text-sm font-medium text-gray-700 mb-1">Maktab *</label>
                    <select id="randomStudentsSchool" required class="w-full px-4 py-2 border border-gray-300 rounded-lg focus:outline-none focus:ring-2 focus:ring-blue-500">
                        <option value="">Maktab tanlang</option>
                    </select>
                </div>
                <div>
                    <label class="block text-sm font-medium text-gray-700 mb-1">Studentlar soni *</label>
                    <input type="number" id="randomStudentsCount" required min="1" max="100" class="w-full px-4 py-2 border border-gray-300 rounded-lg focus:outline-none focus:ring-2 focus:ring-blue-500" placeholder="1 dan 100 gacha">
                </div>
                <div>
                    <label class="block text-sm font-medium text-gray-700 mb-1">Umumiy parol *</label>
                    <input type="text" id="randomStudentsPassword" required class="w-full px-4 py-2 border border-gray-300 rounded-lg focus:outline-none focus:ring-2 focus:ring-blue-500" placeholder="Barcha studentlar uchun bir xil parol">
                </div>
                <div class="p-3 bg-blue-50 rounded-lg">
                    <p class="text-sm text-blue-800"><i class="fas fa-info-circle mr-2"></i>Studentlar telefon raqamlari avtomatik ravishda yaratiladi (+998920XXXXXXX formatda)</p>
                </div>
                <div class="flex items-center justify-end space-x-3 pt-2">
                    <button type="button" id="cancelRandomStudents" class="px-4 py-2 border border-gray-300 rounded-lg text-gray-700 hover:bg-gray-50">Bekor qilish</button>
                    <button type="submit" class="px-4 py-2 bg-green-600 text-white rounded-lg hover:bg-green-700">Yaratish</button>
                </div>
            </form>
        </div>
    </div>

    <!-- Create Payment Modal -->
    <div id="createPaymentOverlay" class="fixed inset-0 bg-black bg-opacity-50 hidden items-center justify-center z-50 p-4">
        <div class="bg-white rounded-xl shadow-2xl w-full max-w-lg p-4 md:p-6 max-h-[90vh] overflow-y-auto">
            <div class="flex items-center justify-between mb-4">
                <div>
                    <p class="text-xs text-gray-500">Yangi to'lov yaratish</p>
                    <h3 class="text-xl font-semibold text-gray-800">Yangi to'lov</h3>
                </div>
                <button id="closeCreatePayment" class="text-gray-500 hover:text-gray-700"><i class="fas fa-times"></i></button>
            </div>
            <form id="createPaymentForm" class="space-y-4">
                <div>
                    <label class="block text-sm font-medium text-gray-700 mb-1">Maktab *</label>
                    <select id="createPaymentSchool" required class="w-full px-4 py-2 border border-gray-300 rounded-lg focus:outline-none focus:ring-2 focus:ring-blue-500">
                        <option value="">Maktab tanlang</option>
                    </select>
                </div>
                <div>
                    <label class="block text-sm font-medium text-gray-700 mb-1">Summa (so'm) *</label>
                    <input type="number" id="createPaymentAmount" required min="0" class="w-full px-4 py-2 border border-gray-300 rounded-lg focus:outline-none focus:ring-2 focus:ring-blue-500" placeholder="1000000">
                </div>
                <div class="grid grid-cols-1 md:grid-cols-2 gap-4">
                    <div>
                        <label class="block text-sm font-medium text-gray-700 mb-1">To'lov sanasi *</label>
                        <input type="date" id="createPaymentDate" required class="w-full px-4 py-2 border border-gray-300 rounded-lg focus:outline-none focus:ring-2 focus:ring-blue-500">
                    </div>
                    <div>
                        <label class="block text-sm font-medium text-gray-700 mb-1">Obuna turi *</label>
                        <select id="createPaymentSubscriptionType" required class="w-full px-4 py-2 border border-gray-300 rounded-lg focus:outline-none focus:ring-2 focus:ring-blue-500">
                            <option value="monthly">Oyli</option>
                            <option value="yearly">Yillik</option>
                        </select>
                    </div>
                </div>
                <div>
                    <label class="block text-sm font-medium text-gray-700 mb-1">Tugash sanasi</label>
                    <input type="date" id="createPaymentExpiryDate" readonly class="w-full px-4 py-2 border border-gray-300 rounded-lg bg-gray-50">
                </div>
                <div>
                    <label class="block text-sm font-medium text-gray-700 mb-1">Status</label>
                    <div class="flex items-center mt-2">
                        <label class="status-switch">
                            <input type="checkbox" id="createPaymentStatusToggle" checked>
                            <span class="status-slider"></span>
                        </label>
                        <span id="createPaymentStatusLabel" class="status-label status-active ml-2">To'langan</span>
                    </div>
                </div>
                <div class="flex items-center justify-end space-x-3 pt-2">
                    <button type="button" id="cancelCreatePayment" class="px-4 py-2 border border-gray-300 rounded-lg text-gray-700 hover:bg-gray-50">Bekor qilish</button>
                    <button type="submit" class="px-4 py-2 bg-blue-600 text-white rounded-lg hover:bg-blue-700">Yaratish</button>
                </div>
            </form>
        </div>
    </div>

    <!-- Create Demo User Modal -->
    <div id="createDemoUserOverlay" class="fixed inset-0 bg-black bg-opacity-50 hidden items-center justify-center z-50 p-4">
        <div class="bg-white rounded-xl shadow-2xl w-full max-w-lg p-4 md:p-6 max-h-[90vh] overflow-y-auto">
            <div class="flex items-center justify-between mb-4">
                <div>
                    <p class="text-xs text-gray-500">Yangi demo foydalanuvchi yaratish</p>
                    <h3 class="text-xl font-semibold text-gray-800">Yangi demo foydalanuvchi</h3>
                </div>
                <button id="closeCreateDemoUser" class="text-gray-500 hover:text-gray-700"><i class="fas fa-times"></i></button>
            </div>
            <form id="createDemoUserForm" class="space-y-4">
                <div>
                    <label class="block text-sm font-medium text-gray-700 mb-1">Ism *</label>
                    <input type="text" id="createDemoUserName" required class="w-full px-4 py-2 border border-gray-300 rounded-lg focus:outline-none focus:ring-2 focus:ring-blue-500">
                </div>
                <div>
                    <label class="block text-sm font-medium text-gray-700 mb-1">Telefon *</label>
                    <input type="tel" id="createDemoUserPhone" required pattern="^\+998[0-9]{9}$" class="w-full px-4 py-2 border border-gray-300 rounded-lg focus:outline-none focus:ring-2 focus:ring-blue-500" placeholder="+998901234567">
                </div>
                <div>
                    <label class="block text-sm font-medium text-gray-700 mb-1">Parol *</label>
                    <input type="text" id="createDemoUserPassword" required class="w-full px-4 py-2 border border-gray-300 rounded-lg focus:outline-none focus:ring-2 focus:ring-blue-500">
                </div>
                <div class="grid grid-cols-1 md:grid-cols-2 gap-4">
                    <div>
                        <label class="block text-sm font-medium text-gray-700 mb-1">Yaratilgan sana *</label>
                        <input type="date" id="createDemoUserCreatedDate" required class="w-full px-4 py-2 border border-gray-300 rounded-lg focus:outline-none focus:ring-2 focus:ring-blue-500">
                    </div>
                    <div>
                        <label class="block text-sm font-medium text-gray-700 mb-1">Tugash sanasi</label>
                        <input type="date" id="createDemoUserExpiryDate" readonly class="w-full px-4 py-2 border border-gray-300 rounded-lg bg-gray-50">
                    </div>
                </div>
                <div class="p-3 bg-purple-50 rounded-lg">
                    <p class="text-sm text-purple-800"><i class="fas fa-info-circle mr-2"></i>Demo foydalanuvchilar 7 kunlik muddatga beriladi. Muddat o'tgach, ular avtomatik ravishda bloklanadi.</p>
                </div>
                <div class="flex items-center justify-end space-x-3 pt-2">
                    <button type="button" id="cancelCreateDemoUser" class="px-4 py-2 border border-gray-300 rounded-lg text-gray-700 hover:bg-gray-50">Bekor qilish</button>
                    <button type="submit" class="px-4 py-2 bg-purple-600 text-white rounded-lg hover:bg-purple-700">Yaratish</button>
                </div>
            </form>
        </div>
    </div>

    <!-- Profile Settings Modal -->
    <div id="profileSettingsOverlay" class="fixed inset-0 bg-black bg-opacity-50 hidden items-center justify-center z-50 p-4">
        <div class="bg-white rounded-xl shadow-2xl w-full max-w-lg p-4 md:p-6 max-h-[90vh] overflow-y-auto">
            <div class="flex items-center justify-between mb-4">
                <div>
                    <p class="text-xs text-gray-500">Profil sozlamalari</p>
                    <h3 class="text-xl font-semibold text-gray-800">Profil ma'lumotlarini tahrirlash</h3>
                </div>
                <button id="closeProfileSettings" class="text-gray-500 hover:text-gray-700"><i class="fas fa-times"></i></button>
            </div>
            <form id="profileSettingsForm" class="space-y-4">
                <div>
                    <label class="block text-sm font-medium text-gray-700 mb-1">Ism</label>
                    <input type="text" id="profileNameInput" required class="w-full px-4 py-2 border border-gray-300 rounded-lg focus:outline-none focus:ring-2 focus:ring-blue-500">
                </div>
                <div>
                    <label class="block text-sm font-medium text-gray-700 mb-1">Telefon</label>
                    <input type="tel" id="profilePhoneInput" required class="w-full px-4 py-2 border border-gray-300 rounded-lg focus:outline-none focus:ring-2 focus:ring-blue-500">
                </div>
                <div>
                    <label class="block text-sm font-medium text-gray-700 mb-1">Eski parol</label>
                    <input type="password" id="profileOldPassword" class="w-full px-4 py-2 border border-gray-300 rounded-lg focus:outline-none focus:ring-2 focus:ring-blue-500" placeholder="Parolni o'zgartirish uchun kiriting">
                </div>
                <div>
                    <label class="block text-sm font-medium text-gray-700 mb-1">Yangi parol</label>
                    <input type="password" id="profileNewPassword" class="w-full px-4 py-2 border border-gray-300 rounded-lg focus:outline-none focus:ring-2 focus:ring-blue-500" placeholder="Yangi parolni kiriting">
                </div>
                <div class="flex items-center justify-end space-x-3 pt-2">
                    <button type="button" id="cancelProfileSettings" class="px-4 py-2 border border-gray-300 rounded-lg text-gray-700 hover:bg-gray-50">Bekor qilish</button>
                    <button type="submit" class="px-4 py-2 bg-blue-600 text-white rounded-lg hover:bg-blue-700">Saqlash</button>
                </div>
            </form>
        </div>
    </div>

    <!-- Confirmation Modal -->
    <div id="confirmationOverlay" class="fixed inset-0 bg-black bg-opacity-50 hidden items-center justify-center z-50 p-4">
        <div class="bg-white rounded-xl shadow-2xl w-full max-w-md p-4 md:p-6">
            <div class="flex items-center justify-between mb-4">
                <h3 class="text-xl font-semibold text-gray-800" id="confirmationTitle">Tasdiqlash</h3>
                <button id="closeConfirmation" class="text-gray-500 hover:text-gray-700"><i class="fas fa-times"></i></button>
            </div>
            <p class="text-gray-700 mb-6" id="confirmationMessage">Haqiqatan ham o'chirmoqchimisiz?</p>
            <div class="flex items-center justify-end space-x-3">
                <button type="button" id="cancelConfirmation" class="px-4 py-2 border border-gray-300 rounded-lg text-gray-700 hover:bg-gray-50">Bekor qilish</button>
                <button type="button" id="confirmAction" class="px-4 py-2 bg-red-600 text-white rounded-lg hover:bg-red-700">O'chirish</button>
            </div>
        </div>
    </div>

    <!-- Success/Error Message Toast -->
    <div id="toast" class="fixed bottom-4 right-4 bg-green-600 text-white px-6 py-3 rounded-lg shadow-lg hidden z-50">
        <div class="flex items-center">
            <i class="fas fa-check-circle mr-2"></i>
            <span id="toastMessage">Amal muvaffaqiyatli bajarildi!</span>
        </div>
    </div>

    <script>
        // Data Management Module
        const DataManager = (function() {
            // Initialize data from localStorage or create default data
            const initializeData = () => {
                const data = {
                    schools: JSON.parse(localStorage.getItem('schools')) || generateSampleSchools(),
                    users: JSON.parse(localStorage.getItem('users')) || generateSampleUsers(),
                    payments: JSON.parse(localStorage.getItem('payments')) || generateSamplePayments(),
                    demoUsers: JSON.parse(localStorage.getItem('demoUsers')) || generateSampleDemoUsers(),
                    profile: JSON.parse(localStorage.getItem('profile')) || {
                        name: "Yoqubov Shehroz",
                        phone: "+998901234567"
                    }
                };
                
                // Save to localStorage
                Object.keys(data).forEach(key => {
                    localStorage.setItem(key, JSON.stringify(data[key]));
                });
                
                return data;
            };
            
            // Generate sample schools
            const generateSampleSchools = () => {
                const now = new Date();
                const schools = [];
                
                const schoolNames = [
                    "ShehrozAvtobilim", "Avtobilim", "Avtotehnika", "Avtobotuz", "Avtobilim PRO",
                    "AvtoTeach", "AvtoAcademy", "AvtoDrive", "AvtoMaster", "AvtoExpert"
                ];
                
                const regions = ["Toshkent", "Samarqand", "Farg'ona", "Andijon", "Namangan", "Buxoro"];
                const districts = ["Yunusobod", "Chilonzor", "Yakkasaroy", "Kattakurgan", "Marg'ilon", "Urgut"];
                
                for (let i = 1; i <= 10; i++) {
                    const paymentDate = new Date(now);
                    paymentDate.setDate(paymentDate.getDate() - Math.floor(Math.random() * 30));
                    
                    const subscriptionType = Math.random() > 0.5 ? "monthly" : "yearly";
                    const expiryDate = new Date(paymentDate);
                    
                    if (subscriptionType === "monthly") {
                        expiryDate.setMonth(expiryDate.getMonth() + 1);
                    } else {
                        expiryDate.setFullYear(expiryDate.getFullYear() + 1);
                    }
                    
                    // Some schools should be expired or expiring soon
                    if (i <= 3) {
                        expiryDate.setDate(expiryDate.getDate() - Math.floor(Math.random() * 10));
                    } else if (i <= 6) {
                        expiryDate.setDate(expiryDate.getDate() + Math.floor(Math.random() * 15));
                    }
                    
                    schools.push({
                        id: i,
                        name: schoolNames[i-1],
                        phone: `+99890${1000000 + i}`,
                        paymentDate: paymentDate.toISOString().split('T')[0],
                        expiryDate: expiryDate.toISOString().split('T')[0],
                        subscriptionType: subscriptionType,
                        status: i === 4 ? "blocked" : "active",
                        createdAt: new Date().toISOString().split('T')[0]
                    });
                }
                
                return schools;
            };
            
            // Generate sample users
            const generateSampleUsers = () => {
                const users = [];
                
                // Admin users
                const adminNames = ["Ali Valiyev", "Sardor Karimov", "Dilshod Rahimov", "Olimjon Toshmatov", "Javohir Ismoilov"];
                const schoolNames = ["ShehrozAvtobilim", "Avtobilim", "Avtotehnika", "Avtobotuz", "Avtobilim PRO"];
                
                for (let i = 1; i <= 5; i++) {
                    users.push({
                        id: i,
                        name: adminNames[i-1],
                        phone: `+99890${1000000 + i}`,
                        password: "********",
                        role: "admin",
                        schoolId: i,
                        schoolName: schoolNames[i-1],
                        status: i === 4 ? "blocked" : "active",
                        createdAt: new Date().toISOString().split('T')[0]
                    });
                }
                
                // Student users
                const studentNames = [
                    "Aziza Karimova", "Bekzod Xolmatov", "Diyor Abdulhayev", "Madina Rasulova", "Sabrina Ergasheva",
                    "Farhod Abdullayev", "Bobur Turgunov", "Shahzod Mirzayev", "Nozima Qodirova", "Javlon Yusupov"
                ];
                
                for (let i = 6; i <= 15; i++) {
                    const schoolId = Math.floor(Math.random() * 5) + 1;
                    users.push({
                        id: i,
                        name: studentNames[i-6],
                        phone: `+99890${2000000 + i}`,
                        password: "password123",
                        role: "student",
                        schoolId: schoolId,
                        schoolName: schoolNames[schoolId-1],
                        status: Math.random() > 0.8 ? "blocked" : "active",
                        createdAt: new Date().toISOString().split('T')[0]
                    });
                }
                
                return users;
            };
            
            // Generate sample payments
            const generateSamplePayments = () => {
                const payments = [];
                const now = new Date();
                
                const schoolNames = ["ShehrozAvtobilim", "Avtobilim", "Avtotehnika", "Avtobotuz", "Avtobilim PRO"];
                const amounts = [500000, 750000, 1000000, 1250000, 1500000];
                
                for (let i = 1; i <= 15; i++) {
                    const paymentDate = new Date(now);
                    paymentDate.setDate(paymentDate.getDate() - Math.floor(Math.random() * 90));
                    
                    const subscriptionType = Math.random() > 0.5 ? "monthly" : "yearly";
                    const expiryDate = new Date(paymentDate);
                    
                    if (subscriptionType === "monthly") {
                        expiryDate.setMonth(expiryDate.getMonth() + 1);
                    } else {
                        expiryDate.setFullYear(expiryDate.getFullYear() + 1);
                    }
                    
                    // Some payments should be overdue
                    const isOverdue = i <= 3 && expiryDate < now;
                    
                    payments.push({
                        id: i,
                        schoolId: (i % 5) + 1,
                        schoolName: schoolNames[(i % 5)],
                        amount: amounts[Math.floor(Math.random() * amounts.length)],
                        paymentDate: paymentDate.toISOString().split('T')[0],
                        expiryDate: expiryDate.toISOString().split('T')[0],
                        subscriptionType: subscriptionType,
                        status: isOverdue ? "overdue" : "paid",
                        createdAt: new Date().toISOString().split('T')[0]
                    });
                }
                
                return payments;
            };
            
            // Generate sample demo users
            const generateSampleDemoUsers = () => {
                const demoUsers = [];
                const now = new Date();
                
                const demoNames = ["Demo User 1", "Demo User 2", "Demo User 3", "Demo User 4", "Demo User 5"];
                
                for (let i = 1; i <= 5; i++) {
                    const createdDate = new Date(now);
                    createdDate.setDate(createdDate.getDate() - Math.floor(Math.random() * 10));
                    
                    const expiryDate = new Date(createdDate);
                    expiryDate.setDate(expiryDate.getDate() + 7);
                    
                    const isExpired = expiryDate < now;
                    
                    demoUsers.push({
                        id: i,
                        name: demoNames[i-1],
                        phone: `+99892${1000000 + i}`,
                        password: "demo123",
                        createdDate: createdDate.toISOString().split('T')[0],
                        expiryDate: expiryDate.toISOString().split('T')[0],
                        status: isExpired ? "blocked" : "active",
                        daysLeft: Math.max(0, Math.ceil((expiryDate - now) / (1000 * 60 * 60 * 24)))
                    });
                }
                
                return demoUsers;
            };
            
            // Save data to localStorage
            const saveData = (key, data) => {
                localStorage.setItem(key, JSON.stringify(data));
            };
            
            // Get all data
            const getAllData = () => {
                return {
                    schools: JSON.parse(localStorage.getItem('schools')) || [],
                    users: JSON.parse(localStorage.getItem('users')) || [],
                    payments: JSON.parse(localStorage.getItem('payments')) || [],
                    demoUsers: JSON.parse(localStorage.getItem('demoUsers')) || [],
                    profile: JSON.parse(localStorage.getItem('profile')) || {}
                };
            };
            
            // Get next ID for a given data type
            const getNextId = (dataType) => {
                const data = JSON.parse(localStorage.getItem(dataType)) || [];
                if (data.length === 0) return 1;
                return Math.max(...data.map(item => item.id)) + 1;
            };
            
            // Add new item
            const addItem = (dataType, item) => {
                const data = JSON.parse(localStorage.getItem(dataType)) || [];
                data.push(item);
                saveData(dataType, data);
                return item;
            };
            
            // Update item
            const updateItem = (dataType, id, updates) => {
                const data = JSON.parse(localStorage.getItem(dataType)) || [];
                const index = data.findIndex(item => item.id == id);
                if (index !== -1) {
                    data[index] = { ...data[index], ...updates };
                    saveData(dataType, data);
                    return data[index];
                }
                return null;
            };
            
            // Delete item
            const deleteItem = (dataType, id) => {
                const data = JSON.parse(localStorage.getItem(dataType)) || [];
                const filteredData = data.filter(item => item.id != id);
                saveData(dataType, filteredData);
                return filteredData.length !== data.length;
            };
            
            // Cascade block - block all students when school is blocked
            const cascadeBlock = (schoolId, blockStatus) => {
                const users = JSON.parse(localStorage.getItem('users')) || [];
                const updatedUsers = users.map(user => {
                    if (user.schoolId == schoolId && user.role === 'student') {
                        return { ...user, status: blockStatus ? 'blocked' : 'active' };
                    }
                    return user;
                });
                saveData('users', updatedUsers);
            };
            
            // Check for expired items
            const checkExpiries = () => {
                const now = new Date();
                let expiringCount = 0;
                
                // Check schools
                const schools = JSON.parse(localStorage.getItem('schools')) || [];
                const updatedSchools = schools.map(school => {
                    const expiryDate = new Date(school.expiryDate);
                    const daysDiff = Math.ceil((expiryDate - now) / (1000 * 60 * 60 * 24));
                    
                    if (daysDiff <= 30 && daysDiff > 0) {
                        expiringCount++;
                    }
                    
                    // Auto-block expired schools
                    if (expiryDate < now && school.status === 'active') {
                        cascadeBlock(school.id, true);
                        return { ...school, status: 'expired' };
                    }
                    
                    return school;
                });
                
                saveData('schools', updatedSchools);
                
                // Check demo users
                const demoUsers = JSON.parse(localStorage.getItem('demoUsers')) || [];
                const updatedDemoUsers = demoUsers.map(demoUser => {
                    const expiryDate = new Date(demoUser.expiryDate);
                    
                    // Auto-block expired demo users
                    if (expiryDate < now && demoUser.status === 'active') {
                        return { ...demoUser, status: 'blocked' };
                    }
                    
                    return demoUser;
                });
                
                saveData('demoUsers', updatedDemoUsers);
                
                return expiringCount;
            };
            
            // Generate random phone number
            const generateRandomPhone = () => {
                const prefix = "+99892";
                const randomNumber = Math.floor(1000000 + Math.random() * 9000000);
                return prefix + randomNumber;
            };
            
            // Generate random students
            const generateRandomStudents = (schoolId, count, password) => {
                const users = JSON.parse(localStorage.getItem('users')) || [];
                const schools = JSON.parse(localStorage.getItem('schools')) || [];
                const school = schools.find(s => s.id == schoolId);
                
                if (!school) return [];
                
                const newStudents = [];
                const studentNames = [
                    "Alisher", "Bekzod", "Dilshod", "Farhod", "G'ayrat", "Husan", "Javlon", "Kamol", "Laziz", "Murod",
                    "Nodir", "Olim", "Parviz", "Qodir", "Rustam", "Sardor", "Temur", "Ulug'bek", "Vohid", "Xurshid",
                    "Yusuf", "Zafar", "Aziza", "Bahriniso", "Dilbar", "Fotima", "Gulnora", "Hilola", "Jasmina", "Kamola"
                ];
                
                const lastNames = [
                    "Aliyev", "Valiyev", "Karimov", "Rahimov", "Toshmatov", "Ismoilov", "Abdullayev", "Turgunov", 
                    "Mirzayev", "Qodirov", "Yusupov", "Hasanov", "Olimov", "Fayzullayev", "G'aniyev", "To'rayev"
                ];
                
                const nextId = getNextId('users');
                
                for (let i = 0; i < count; i++) {
                    const randomName = studentNames[Math.floor(Math.random() * studentNames.length)];
                    const randomLastName = lastNames[Math.floor(Math.random() * lastNames.length)];
                    
                    const newStudent = {
                        id: nextId + i,
                        name: `${randomName} ${randomLastName}`,
                        phone: generateRandomPhone(),
                        password: password,
                        role: 'student',
                        schoolId: schoolId,
                        schoolName: school.name,
                        status: 'active',
                        createdAt: new Date().toISOString().split('T')[0]
                    };
                    
                    newStudents.push(newStudent);
                    users.push(newStudent);
                }
                
                saveData('users', users);
                return newStudents;
            };
            
            return {
                initializeData,
                getAllData,
                getNextId,
                addItem,
                updateItem,
                deleteItem,
                cascadeBlock,
                checkExpiries,
                generateRandomStudents,
                saveData
            };
        })();

        // UI Module
        const UIManager = (function() {
            // Show toast message
            const showToast = (message, type = 'success') => {
                const toast = document.getElementById('toast');
                const toastMessage = document.getElementById('toastMessage');
                
                toastMessage.textContent = message;
                
                // Set color based on type
                if (type === 'success') {
                    toast.className = 'fixed bottom-4 right-4 bg-green-600 text-white px-6 py-3 rounded-lg shadow-lg z-50 flex items-center';
                } else if (type === 'error') {
                    toast.className = 'fixed bottom-4 right-4 bg-red-600 text-white px-6 py-3 rounded-lg shadow-lg z-50 flex items-center';
                } else if (type === 'warning') {
                    toast.className = 'fixed bottom-4 right-4 bg-amber-500 text-white px-6 py-3 rounded-lg shadow-lg z-50 flex items-center';
                }
                
                toast.classList.remove('hidden');
                
                // Hide after 3 seconds
                setTimeout(() => {
                    toast.classList.add('hidden');
                }, 3000);
            };
            
            // Show confirmation dialog
            const showConfirmation = (title, message, callback) => {
                const overlay = document.getElementById('confirmationOverlay');
                const titleElement = document.getElementById('confirmationTitle');
                const messageElement = document.getElementById('confirmationMessage');
                const confirmButton = document.getElementById('confirmAction');
                const closeButton = document.getElementById('closeConfirmation');
                const cancelButton = document.getElementById('cancelConfirmation');
                
                titleElement.textContent = title;
                messageElement.textContent = message;
                
                overlay.classList.remove('hidden');
                overlay.classList.add('flex');
                
                const closeModal = () => {
                    overlay.classList.add('hidden');
                    overlay.classList.remove('flex');
                    confirmButton.removeEventListener('click', confirmHandler);
                    closeButton.removeEventListener('click', closeHandler);
                    cancelButton.removeEventListener('click', closeHandler);
                };
                
                const confirmHandler = () => {
                    callback();
                    closeModal();
                };
                
                const closeHandler = () => {
                    closeModal();
                };
                
                confirmButton.addEventListener('click', confirmHandler);
                closeButton.addEventListener('click', closeHandler);
                cancelButton.addEventListener('click', closeHandler);
            };
            
            // Format date
            const formatDate = (dateString) => {
                if (!dateString) return '-';
                const date = new Date(dateString);
                return date.toLocaleDateString('uz-UZ');
            };
            
            // Format currency
            const formatCurrency = (amount) => {
                return new Intl.NumberFormat('uz-UZ').format(amount) + ' so\'m';
            };
            
            // Calculate days between dates
            const getDaysBetween = (dateString) => {
                if (!dateString) return 0;
                const date = new Date(dateString);
                const now = new Date();
                const diffTime = date - now;
                return Math.ceil(diffTime / (1000 * 60 * 60 * 24));
            };
            
            // Get status badge
            const getStatusBadge = (status, type = 'default') => {
                let badgeClass = '';
                let badgeText = '';
                
                switch(status) {
                    case 'active':
                        badgeClass = 'badge-active';
                        badgeText = 'Aktiv';
                        break;
                    case 'blocked':
                        badgeClass = 'badge-blocked';
                        badgeText = 'Bloklangan';
                        break;
                    case 'expired':
                        badgeClass = 'badge-expired';
                        badgeText = 'Muddati tugagan';
                        break;
                    case 'paid':
                        badgeClass = 'badge-paid';
                        badgeText = 'To\'langan';
                        break;
                    case 'overdue':
                        badgeClass = 'badge-overdue';
                        badgeText = 'Muddati o\'tgan';
                        break;
                    default:
                        badgeClass = 'badge-active';
                        badgeText = 'Aktiv';
                }
                
                if (type === 'demo') {
                    badgeClass = 'badge-demo';
                    badgeText = 'Demo';
                }
                
                return `<span class="badge ${badgeClass}">${badgeText}</span>`;
            };
            
            // Update status label for switches
            const updateStatusLabel = (checkbox, labelElement) => {
                if (checkbox.checked) {
                    labelElement.textContent = "Aktiv";
                    labelElement.className = "status-label status-active";
                } else {
                    labelElement.textContent = "Bloklangan";
                    labelElement.className = "status-label status-blocked";
                }
            };
            
            // Initialize status switches
            const initStatusSwitches = () => {
                document.querySelectorAll('.status-toggle').forEach(checkbox => {
                    const label = checkbox.closest('td')?.querySelector('.status-label');
                    if (label) {
                        updateStatusLabel(checkbox, label);
                        
                        checkbox.addEventListener('change', function() {
                            updateStatusLabel(this, label);
                        });
                    }
                });
            };
            
            return {
                showToast,
                showConfirmation,
                formatDate,
                formatCurrency,
                getDaysBetween,
                getStatusBadge,
                updateStatusLabel,
                initStatusSwitches
            };
        })();

        // Table Manager Module
        const TableManager = (function() {
            let currentPage = {
                schools: 1,
                users: 1,
                payments: 1,
                demoUsers: 1
            };
            
            let pageSize = {
                schools: 10,
                users: 10,
                payments: 10,
                demoUsers: 10
            };
            
            let sortConfig = {
                schools: { field: 'id', direction: 'asc' },
                users: { field: 'id', direction: 'asc' },
                payments: { field: 'id', direction: 'asc' },
                demoUsers: { field: 'id', direction: 'asc' }
            };
            
            // Render schools table
            const renderSchoolsTable = (filteredData = null) => {
                const schools = filteredData || DataManager.getAllData().schools;
                const tbody = document.getElementById('schoolsTableBody');
                const countText = document.getElementById('schoolsCountText');
                const currentPageElement = document.getElementById('schoolCurrentPage');
                
                // Apply sorting
                const sortedSchools = sortData(schools, 'schools');
                
                // Apply pagination
                const startIndex = (currentPage.schools - 1) * pageSize.schools;
                const endIndex = startIndex + pageSize.schools;
                const paginatedSchools = sortedSchools.slice(startIndex, endIndex);
                
                // Clear table
                tbody.innerHTML = '';
                
                // Render rows
                paginatedSchools.forEach(school => {
                    const daysLeft = UIManager.getDaysBetween(school.expiryDate);
                    const isExpiring = daysLeft > 0 && daysLeft <= 30;
                    
                    const row = document.createElement('tr');
                    row.className = `table-row-hover ${isExpiring ? 'expiring-row' : ''}`;
                    row.innerHTML = `
                        <td class="px-2 md:px-4 py-2 text-gray-700">${school.id}</td>
                        <td class="px-2 md:px-4 py-2 font-medium text-gray-900 cursor-pointer hover:text-blue-600 hover:underline" 
                            onclick="TableManager.showSchoolDetails(${school.id})">
                            ${school.name}
                        </td>
                        <td class="px-2 md:px-4 py-2 text-gray-700">${school.phone}</td>
                        <td class="px-2 md:px-4 py-2 text-gray-700">${UIManager.formatDate(school.paymentDate)}</td>
                        <td class="px-2 md:px-4 py-2 text-gray-700">${UIManager.formatDate(school.expiryDate)}</td>
                        <td class="px-2 md:px-4 py-2 text-gray-700">
                            ${school.subscriptionType === 'monthly' ? 'Oyli' : 'Yillik'}
                        </td>
                        <td class="px-2 md:px-4 py-2">
                            ${UIManager.getStatusBadge(school.status)}
                            ${isExpiring ? `<span class="ml-1 text-xs text-red-600">(${daysLeft} kun)</span>` : ''}
                        </td>
                        <td class="px-2 md:px-4 py-2 space-x-1 md:space-x-2">
                            <button class="editSchoolBtn px-2 md:px-3 py-1 rounded bg-blue-600 text-white text-xs hover:bg-blue-700" data-id="${school.id}">Tahrirlash</button>
                            <button class="deleteSchoolBtn px-2 md:px-3 py-1 rounded bg-red-100 text-red-600 text-xs hover:bg-red-200" data-id="${school.id}">O'chirish</button>
                            <button class="toggleSchoolBtn px-2 md:px-3 py-1 rounded ${school.status === 'active' ? 'bg-amber-100 text-amber-600 hover:bg-amber-200' : 'bg-green-100 text-green-600 hover:bg-green-200'} text-xs" data-id="${school.id}" data-status="${school.status}">
                                ${school.status === 'active' ? 'Bloklash' : 'Ochish'}
                            </button>
                        </td>
                    `;
                    tbody.appendChild(row);
                });
                
                // Update pagination info
                countText.textContent = `Jami ${schools.length} ta maktab`;
                currentPageElement.textContent = currentPage.schools;
                
                // Update pagination buttons state
                document.getElementById('schoolPrevPage').disabled = currentPage.schools === 1;
                document.getElementById('schoolNextPage').disabled = endIndex >= schools.length;
                
                // Attach event listeners
                attachSchoolEventListeners();
            };
            
            // Render users table
            const renderUsersTable = (filteredData = null) => {
                const users = filteredData || DataManager.getAllData().users;
                const tbody = document.getElementById('usersTableBody');
                const countText = document.getElementById('usersCountText');
                const currentPageElement = document.getElementById('userCurrentPage');
                
                // Apply sorting
                const sortedUsers = sortData(users, 'users');
                
                // Apply pagination
                const startIndex = (currentPage.users - 1) * pageSize.users;
                const endIndex = startIndex + pageSize.users;
                const paginatedUsers = sortedUsers.slice(startIndex, endIndex);
                
                // Clear table
                tbody.innerHTML = '';
                
                // Render rows
                paginatedUsers.forEach(user => {
                    const row = document.createElement('tr');
                    row.className = `table-row-hover ${user.role === 'admin' ? 'admin-row' : 'student-row'}`;
                    row.innerHTML = `
                        <td class="px-2 md:px-4 py-2 text-gray-700">${user.id}</td>
                        <td class="px-2 md:px-4 py-2 font-medium text-gray-900">${user.name}</td>
                        <td class="px-2 md:px-4 py-2 text-gray-700">${user.phone}</td>
                        <td class="px-2 md:px-4 py-2 text-gray-700">${user.password}</td>
                        <td class="px-2 md:px-4 py-2 text-gray-700">
                            <span class="${user.role === 'admin' ? 'font-bold text-blue-600' : 'text-gray-700'}">
                                ${user.role === 'admin' ? 'Admin' : 'Student'}
                            </span>
                        </td>
                        <td class="px-2 md:px-4 py-2 text-gray-700">${user.schoolName || '-'}</td>
                        <td class="px-2 md:px-4 py-2">${UIManager.getStatusBadge(user.status)}</td>
                        <td class="px-2 md:px-4 py-2 text-gray-700">${UIManager.formatDate(user.createdAt)}</td>
                        <td class="px-2 md:px-4 py-2 space-x-1 md:space-x-2">
                            <button class="editUserBtn px-2 md:px-3 py-1 rounded bg-blue-600 text-white text-xs hover:bg-blue-700" data-id="${user.id}">Tahrirlash</button>
                            <button class="deleteUserBtn px-2 md:px-3 py-1 rounded bg-red-100 text-red-600 text-xs hover:bg-red-200" data-id="${user.id}">O'chirish</button>
                        </td>
                    `;
                    tbody.appendChild(row);
                });
                
                // Update pagination info
                countText.textContent = `Jami ${users.length} ta foydalanuvchi`;
                currentPageElement.textContent = currentPage.users;
                
                // Update pagination buttons state
                document.getElementById('userPrevPage').disabled = currentPage.users === 1;
                document.getElementById('userNextPage').disabled = endIndex >= users.length;
                
                // Attach event listeners
                attachUserEventListeners();
            };
            
            // Render payments table
            const renderPaymentsTable = (filteredData = null) => {
                const payments = filteredData || DataManager.getAllData().payments;
                const tbody = document.getElementById('paymentsTableBody');
                const countText = document.getElementById('paymentsCountText');
                const amountText = document.getElementById('totalPaymentsAmount');
                const currentPageElement = document.getElementById('paymentCurrentPage');
                
                // Calculate total amount
                const totalAmount = payments.reduce((sum, payment) => sum + payment.amount, 0);
                
                // Apply sorting
                const sortedPayments = sortData(payments, 'payments');
                
                // Apply pagination
                const startIndex = (currentPage.payments - 1) * pageSize.payments;
                const endIndex = startIndex + pageSize.payments;
                const paginatedPayments = sortedPayments.slice(startIndex, endIndex);
                
                // Clear table
                tbody.innerHTML = '';
                
                // Render rows
                paginatedPayments.forEach(payment => {
                    const row = document.createElement('tr');
                    row.className = 'table-row-hover';
                    row.innerHTML = `
                        <td class="px-2 md:px-4 py-2 text-gray-700">${payment.id}</td>
                        <td class="px-2 md:px-4 py-2 font-medium text-gray-900">${payment.schoolName}</td>
                        <td class="px-2 md:px-4 py-2 text-gray-700 font-semibold">${UIManager.formatCurrency(payment.amount)}</td>
                        <td class="px-2 md:px-4 py-2 text-gray-700">${UIManager.formatDate(payment.paymentDate)}</td>
                        <td class="px-2 md:px-4 py-2 text-gray-700">
                            ${payment.subscriptionType === 'monthly' ? 'Oyli' : 'Yillik'}
                        </td>
                        <td class="px-2 md:px-4 py-2 text-gray-700">${UIManager.formatDate(payment.expiryDate)}</td>
                        <td class="px-2 md:px-4 py-2">${UIManager.getStatusBadge(payment.status)}</td>
                        <td class="px-2 md:px-4 py-2 space-x-1 md:space-x-2">
                            <button class="editPaymentBtn px-2 md:px-3 py-1 rounded bg-blue-600 text-white text-xs hover:bg-blue-700" data-id="${payment.id}">Tahrirlash</button>
                            <button class="deletePaymentBtn px-2 md:px-3 py-1 rounded bg-red-100 text-red-600 text-xs hover:bg-red-200" data-id="${payment.id}">O'chirish</button>
                        </td>
                    `;
                    tbody.appendChild(row);
                });
                
                // Update pagination info
                countText.textContent = `Jami ${payments.length} ta to'lov`;
                amountText.textContent = `Umumiy summa: ${UIManager.formatCurrency(totalAmount)}`;
                currentPageElement.textContent = currentPage.payments;
                
                // Update pagination buttons state
                document.getElementById('paymentPrevPage').disabled = currentPage.payments === 1;
                document.getElementById('paymentNextPage').disabled = endIndex >= payments.length;
                
                // Attach event listeners
                attachPaymentEventListeners();
            };
            
            // Render demo users table
            const renderDemoUsersTable = (filteredData = null) => {
                const demoUsers = filteredData || DataManager.getAllData().demoUsers;
                const tbody = document.getElementById('demoUsersTableBody');
                const countText = document.getElementById('demoUsersCountText');
                const currentPageElement = document.getElementById('demoUserCurrentPage');
                
                // Apply sorting
                const sortedDemoUsers = sortData(demoUsers, 'demoUsers');
                
                // Apply pagination
                const startIndex = (currentPage.demoUsers - 1) * pageSize.demoUsers;
                const endIndex = startIndex + pageSize.demoUsers;
                const paginatedDemoUsers = sortedDemoUsers.slice(startIndex, endIndex);
                
                // Clear table
                tbody.innerHTML = '';
                
                // Render rows
                paginatedDemoUsers.forEach(demoUser => {
                    const daysLeft = UIManager.getDaysBetween(demoUser.expiryDate);
                    const isExpired = daysLeft < 0;
                    
                    const row = document.createElement('tr');
                    row.className = 'table-row-hover';
                    row.innerHTML = `
                        <td class="px-2 md:px-4 py-2 text-gray-700">${demoUser.id}</td>
                        <td class="px-2 md:px-4 py-2 font-medium text-gray-900">${demoUser.name}</td>
                        <td class="px-2 md:px-4 py-2 text-gray-700">${demoUser.phone}</td>
                        <td class="px-2 md:px-4 py-2 text-gray-700">${demoUser.password}</td>
                        <td class="px-2 md:px-4 py-2 text-gray-700">${UIManager.formatDate(demoUser.createdDate)}</td>
                        <td class="px-2 md:px-4 py-2 text-gray-700">${UIManager.formatDate(demoUser.expiryDate)}</td>
                        <td class="px-2 md:px-4 py-2 text-gray-700">
                            <span class="${isExpired ? 'text-red-600 font-bold' : 'text-green-600'}">
                                ${isExpired ? 'Muddati o\'tgan' : `${daysLeft} kun`}
                            </span>
                        </td>
                        <td class="px-2 md:px-4 py-2">
                            ${UIManager.getStatusBadge(demoUser.status, 'demo')}
                        </td>
                        <td class="px-2 md:px-4 py-2 space-x-1 md:space-x-2">
                            <button class="deleteDemoUserBtn px-2 md:px-3 py-1 rounded bg-red-100 text-red-600 text-xs hover:bg-red-200" data-id="${demoUser.id}">O'chirish</button>
                        </td>
                    `;
                    tbody.appendChild(row);
                });
                
                // Update pagination info
                countText.textContent = `Jami ${demoUsers.length} ta demo foydalanuvchi`;
                currentPageElement.textContent = currentPage.demoUsers;
                
                // Update pagination buttons state
                document.getElementById('demoUserPrevPage').disabled = currentPage.demoUsers === 1;
                document.getElementById('demoUserNextPage').disabled = endIndex >= demoUsers.length;
                
                // Attach event listeners
                attachDemoUserEventListeners();
            };
            
            // Render expiring soon list
            const renderExpiringSoonList = () => {
                const schools = DataManager.getAllData().schools;
                const expiringDays = parseInt(document.getElementById('expiringDaysFilter').value) || 7;
                const now = new Date();
                
                // Filter schools expiring soon
                const expiringSchools = schools.filter(school => {
                    const expiryDate = new Date(school.expiryDate);
                    const daysDiff = Math.ceil((expiryDate - now) / (1000 * 60 * 60 * 24));
                    return daysDiff > 0 && daysDiff <= expiringDays && school.status !== 'blocked' && school.status !== 'expired';
                });
                
                // Update count in sidebar
                document.getElementById('expiringCount').textContent = expiringSchools.length;
                
                // Render dashboard list
                const dashboardList = document.getElementById('expiringSoonList');
                dashboardList.innerHTML = '';
                
                expiringSchools.slice(0, 5).forEach(school => {
                    const daysLeft = UIManager.getDaysBetween(school.expiryDate);
                    
                    const row = document.createElement('tr');
                    row.className = 'expiring-row';
                    row.innerHTML = `
                        <td class="px-3 py-2 font-medium text-gray-900">${school.name}</td>
                        <td class="px-3 py-2 text-gray-700">
                            <span class="countdown">${daysLeft} kun</span>
                        </td>
                        <td class="px-3 py-2">
                            ${UIManager.getStatusBadge('active')}
                        </td>
                    `;
                    dashboardList.appendChild(row);
                });
                
                // Render expiring section table
                const expiringTableBody = document.getElementById('expiringTableBody');
                const expiringCountText = document.getElementById('expiringCountText');
                
                expiringTableBody.innerHTML = '';
                
                expiringSchools.forEach(school => {
                    const daysLeft = UIManager.getDaysBetween(school.expiryDate);
                    
                    const row = document.createElement('tr');
                    row.className = 'expiring-row';
                    row.innerHTML = `
                        <td class="px-2 md:px-4 py-2 text-gray-700">${school.id}</td>
                        <td class="px-2 md:px-4 py-2 font-medium text-gray-900">${school.name}</td>
                        <td class="px-2 md:px-4 py-2 text-gray-700">${school.phone}</td>
                        <td class="px-2 md:px-4 py-2 text-gray-700">${UIManager.formatDate(school.paymentDate)}</td>
                        <td class="px-2 md:px-4 py-2 text-gray-700">${UIManager.formatDate(school.expiryDate)}</td>
                        <td class="px-2 md:px-4 py-2 text-gray-700">
                            <span class="countdown">${daysLeft} kun</span>
                        </td>
                        <td class="px-2 md:px-4 py-2 text-gray-700">
                            ${school.subscriptionType === 'monthly' ? 'Oyli' : 'Yillik'}
                        </td>
                        <td class="px-2 md:px-4 py-2 space-x-1 md:space-x-2">
                            <button class="remindSchoolBtn px-2 md:px-3 py-1 rounded bg-amber-500 text-white text-xs hover:bg-amber-600" data-id="${school.id}">Xabar yuborish</button>
                            <button class="renewSchoolBtn px-2 md:px-3 py-1 rounded bg-green-600 text-white text-xs hover:bg-green-700" data-id="${school.id}">Yangi to'lov</button>
                        </td>
                    `;
                    expiringTableBody.appendChild(row);
                });
                
                expiringCountText.textContent = `Jami ${expiringSchools.length} ta maktab`;
                
                // Attach event listeners for expiring section
                attachExpiringEventListeners();
            };
            
            // Sort data
            const sortData = (data, tableType) => {
                const config = sortConfig[tableType];
                return [...data].sort((a, b) => {
                    let aValue = a[config.field];
                    let bValue = b[config.field];
                    
                    // Handle special cases
                    if (config.field === 'name' && a.schoolName) {
                        aValue = a.schoolName;
                        bValue = b.schoolName;
                    }
                    
                    if (typeof aValue === 'string') {
                        aValue = aValue.toLowerCase();
                        bValue = bValue.toLowerCase();
                    }
                    
                    if (aValue < bValue) {
                        return config.direction === 'asc' ? -1 : 1;
                    }
                    if (aValue > bValue) {
                        return config.direction === 'asc' ? 1 : -1;
                    }
                    return 0;
                });
            };
            
            // Show school details modal
            const showSchoolDetails = (schoolId) => {
                const data = DataManager.getAllData();
                const school = data.schools.find(s => s.id == schoolId);
                
                if (!school) return;
                
                // Update modal content
                document.getElementById('schoolDetailsTitle').textContent = school.name;
                document.getElementById('detailSchoolName').textContent = school.name;
                document.getElementById('detailSchoolPhone').textContent = school.phone;
                document.getElementById('detailPaymentDate').textContent = UIManager.formatDate(school.paymentDate);
                document.getElementById('detailExpiryDate').textContent = UIManager.formatDate(school.expiryDate);
                document.getElementById('detailSubscriptionType').textContent = school.subscriptionType === 'monthly' ? 'Oyli' : 'Yillik';
                document.getElementById('detailSchoolStatus').innerHTML = UIManager.getStatusBadge(school.status);
                
                // Find admin for this school
                const admin = data.users.find(u => u.schoolId == schoolId && u.role === 'admin');
                const adminInfo = document.getElementById('schoolAdminInfo');
                
                if (admin) {
                    adminInfo.innerHTML = `
                        <div class="space-y-2">
                            <div>
                                <p class="text-sm text-gray-500">Admin ismi</p>
                                <p class="text-base font-medium text-gray-800">${admin.name}</p>
                            </div>
                            <div>
                                <p class="text-sm text-gray-500">Admin telefon</p>
                                <p class="text-base font-medium text-gray-800">${admin.phone}</p>
                            </div>
                            <div>
                                <p class="text-sm text-gray-500">Admin status</p>
                                <p class="text-base font-medium">${UIManager.getStatusBadge(admin.status)}</p>
                            </div>
                        </div>
                    `;
                } else {
                    adminInfo.innerHTML = '<p class="text-gray-500">Bu maktab uchun admin topilmadi</p>';
                }
                
                // Find students for this school
                const students = data.users.filter(u => u.schoolId == schoolId && u.role === 'student');
                const studentsList = document.getElementById('schoolStudentsList');
                const studentsCount = document.getElementById('schoolStudentsCount');
                
                studentsList.innerHTML = '';
                
                students.forEach(student => {
                    const row = document.createElement('tr');
                    row.innerHTML = `
                        <td class="px-3 py-2 text-gray-700">${student.id}</td>
                        <td class="px-3 py-2 text-gray-700">${student.name}</td>
                        <td class="px-3 py-2 text-gray-700">${student.phone}</td>
                        <td class="px-3 py-2">${UIManager.getStatusBadge(student.status)}</td>
                        <td class="px-3 py-2 text-gray-700">${UIManager.formatDate(student.createdAt)}</td>
                    `;
                    studentsList.appendChild(row);
                });
                
                studentsCount.textContent = `Jami ${students.length} ta student`;
                
                // Show modal
                const overlay = document.getElementById('schoolDetailsOverlay');
                overlay.classList.remove('hidden');
                overlay.classList.add('flex');
            };
            
            // Attach event listeners for schools
            const attachSchoolEventListeners = () => {
                // Edit buttons
                document.querySelectorAll('.editSchoolBtn').forEach(btn => {
                    btn.addEventListener('click', function() {
                        const schoolId = this.getAttribute('data-id');
                        openEditSchoolModal(schoolId);
                    });
                });
                
                // Delete buttons
                document.querySelectorAll('.deleteSchoolBtn').forEach(btn => {
                    btn.addEventListener('click', function() {
                        const schoolId = this.getAttribute('data-id');
                        UIManager.showConfirmation(
                            'Maktabni o\'chirish',
                            'Ushbu maktabni o\'chirishni tasdiqlaysizmi? Bu maktabga tegishli barcha admin va studentlar ham o\'chiriladi!',
                            () => {
                                DataManager.deleteItem('schools', schoolId);
                                
                                // Also delete users associated with this school
                                const users = DataManager.getAllData().users;
                                const filteredUsers = users.filter(user => user.schoolId != schoolId);
                                DataManager.saveData('users', filteredUsers);
                                
                                renderSchoolsTable();
                                renderUsersTable();
                                UIManager.showToast('Maktab muvaffaqiyatli o\'chirildi', 'success');
                            }
                        );
                    });
                });
                
                // Toggle status buttons
                document.querySelectorAll('.toggleSchoolBtn').forEach(btn => {
                    btn.addEventListener('click', function() {
                        const schoolId = this.getAttribute('data-id');
                        const currentStatus = this.getAttribute('data-status');
                        const newStatus = currentStatus === 'active' ? 'blocked' : 'active';
                        
                        DataManager.updateItem('schools', schoolId, { status: newStatus });
                        
                        // Cascade block/unblock
                        DataManager.cascadeBlock(schoolId, newStatus === 'blocked');
                        
                        renderSchoolsTable();
                        renderUsersTable();
                        
                        const action = newStatus === 'blocked' ? 'bloklandi' : 'blokdan ochildi';
                        UIManager.showToast(`Maktab ${action}`, 'success');
                    });
                });
            };
            
            // Attach event listeners for users
            const attachUserEventListeners = () => {
                // Edit buttons
                document.querySelectorAll('.editUserBtn').forEach(btn => {
                    btn.addEventListener('click', function() {
                        const userId = this.getAttribute('data-id');
                        openEditUserModal(userId);
                    });
                });
                
                // Delete buttons
                document.querySelectorAll('.deleteUserBtn').forEach(btn => {
                    btn.addEventListener('click', function() {
                        const userId = this.getAttribute('data-id');
                        UIManager.showConfirmation(
                            'Foydalanuvchini o\'chirish',
                            'Ushbu foydalanuvchini o\'chirishni tasdiqlaysizmi?',
                            () => {
                                DataManager.deleteItem('users', userId);
                                renderUsersTable();
                                UIManager.showToast('Foydalanuvchi muvaffaqiyatli o\'chirildi', 'success');
                            }
                        );
                    });
                });
            };
            
            // Attach event listeners for payments
            const attachPaymentEventListeners = () => {
                // Edit buttons
                document.querySelectorAll('.editPaymentBtn').forEach(btn => {
                    btn.addEventListener('click', function() {
                        const paymentId = this.getAttribute('data-id');
                        openEditPaymentModal(paymentId);
                    });
                });
                
                // Delete buttons
                document.querySelectorAll('.deletePaymentBtn').forEach(btn => {
                    btn.addEventListener('click', function() {
                        const paymentId = this.getAttribute('data-id');
                        UIManager.showConfirmation(
                            'To\'lovni o\'chirish',
                            'Ushbu to\'lovni o\'chirishni tasdiqlaysizmi?',
                            () => {
                                DataManager.deleteItem('payments', paymentId);
                                renderPaymentsTable();
                                UIManager.showToast('To\'lov muvaffaqiyatli o\'chirildi', 'success');
                            }
                        );
                    });
                });
            };
            
            // Attach event listeners for demo users
            const attachDemoUserEventListeners = () => {
                // Delete buttons
                document.querySelectorAll('.deleteDemoUserBtn').forEach(btn => {
                    btn.addEventListener('click', function() {
                        const demoUserId = this.getAttribute('data-id');
                        UIManager.showConfirmation(
                            'Demo foydalanuvchini o\'chirish',
                            'Ushbu demo foydalanuvchini o\'chirishni tasdiqlaysizmi?',
                            () => {
                                DataManager.deleteItem('demoUsers', demoUserId);
                                renderDemoUsersTable();
                                UIManager.showToast('Demo foydalanuvchi muvaffaqiyatli o\'chirildi', 'success');
                            }
                        );
                    });
                });
            };
            
            // Attach event listeners for expiring section
            const attachExpiringEventListeners = () => {
                // Remind buttons
                document.querySelectorAll('.remindSchoolBtn').forEach(btn => {
                    btn.addEventListener('click', function() {
                        const schoolId = this.getAttribute('data-id');
                        const data = DataManager.getAllData();
                        const school = data.schools.find(s => s.id == schoolId);
                        
                        if (school) {
                            UIManager.showToast(`Xabar "${school.name}" maktabiga yuborildi`, 'success');
                        }
                    });
                });
                
                // Renew buttons
                document.querySelectorAll('.renewSchoolBtn').forEach(btn => {
                    btn.addEventListener('click', function() {
                        const schoolId = this.getAttribute('data-id');
                        openCreatePaymentModal(schoolId);
                    });
                });
            };
            
            // Open edit school modal
            const openEditSchoolModal = (schoolId) => {
                const data = DataManager.getAllData();
                const school = data.schools.find(s => s.id == schoolId);
                
                if (!school) return;
                
                // Fill form
                document.getElementById('editSchoolId').value = school.id;
                document.getElementById('editSchoolName').value = school.name;
                document.getElementById('editSchoolPhone').value = school.phone;
                document.getElementById('editSchoolPaymentDate').value = school.paymentDate;
                document.getElementById('editSchoolSubscriptionType').value = school.subscriptionType;
                document.getElementById('editSchoolExpiryDate').value = school.expiryDate;
                
                // Set status toggle
                const toggle = document.getElementById('editSchoolStatusToggle');
                const label = document.getElementById('editSchoolStatusLabel');
                toggle.checked = school.status === 'active';
                UIManager.updateStatusLabel(toggle, label);
                
                // Show modal
                const overlay = document.getElementById('editSchoolOverlay');
                overlay.classList.remove('hidden');
                overlay.classList.add('flex');
            };
            
            // Open edit user modal (simplified - would need a separate modal)
            const openEditUserModal = (userId) => {
                const data = DataManager.getAllData();
                const user = data.users.find(u => u.id == userId);
                
                if (!user) return;
                
                // For now, just show a message
                UIManager.showToast('Foydalanuvchi tahrirlash funksiyasi keyingi versiyada qo\'shiladi', 'warning');
            };
            
            // Open edit payment modal (simplified - would need a separate modal)
            const openEditPaymentModal = (paymentId) => {
                const data = DataManager.getAllData();
                const payment = data.payments.find(p => p.id == paymentId);
                
                if (!payment) return;
                
                // For now, just show a message
                UIManager.showToast('To\'lov tahrirlash funksiyasi keyingi versiyada qo\'shiladi', 'warning');
            };
            
            // Open create payment modal with school pre-selected
            const openCreatePaymentModal = (schoolId = null) => {
                const data = DataManager.getAllData();
                const schoolSelect = document.getElementById('createPaymentSchool');
                
                // Populate school select
                schoolSelect.innerHTML = '<option value="">Maktab tanlang</option>';
                data.schools.forEach(school => {
                    const option = document.createElement('option');
                    option.value = school.id;
                    option.textContent = school.name;
                    if (schoolId && school.id == schoolId) {
                        option.selected = true;
                    }
                    schoolSelect.appendChild(option);
                });
                
                // Set default date to today
                const today = new Date().toISOString().split('T')[0];
                document.getElementById('createPaymentDate').value = today;
                
                // Calculate expiry date
                calculateExpiryDate('createPaymentDate', 'createPaymentSubscriptionType', 'createPaymentExpiryDate');
                
                // Show modal
                const overlay = document.getElementById('createPaymentOverlay');
                overlay.classList.remove('hidden');
                overlay.classList.add('flex');
            };
            
            return {
                renderSchoolsTable,
                renderUsersTable,
                renderPaymentsTable,
                renderDemoUsersTable,
                renderExpiringSoonList,
                showSchoolDetails,
                currentPage,
                pageSize,
                sortConfig
            };
        })();

        // Chart Manager Module
        const ChartManager = (function() {
            let revenueChart = null;
            let subscriptionChart = null;
            let topSchoolsChart = null;
            
            // Initialize all charts
            const initCharts = () => {
                initRevenueChart();
                initSubscriptionChart();
                initTopSchoolsChart();
            };
            
            // Initialize revenue chart
            const initRevenueChart = () => {
                const ctx = document.getElementById('revenueChart');
                if (!ctx) return;
                
                const data = DataManager.getAllData();
                const payments = data.payments;
                
                // Group payments by month
                const monthlyRevenue = {};
                payments.forEach(payment => {
                    const date = new Date(payment.paymentDate);
                    const monthYear = `${date.getFullYear()}-${String(date.getMonth() + 1).padStart(2, '0')}`;
                    
                    if (!monthlyRevenue[monthYear]) {
                        monthlyRevenue[monthYear] = 0;
                    }
                    monthlyRevenue[monthYear] += payment.amount;
                });
                
                // Sort months
                const sortedMonths = Object.keys(monthlyRevenue).sort();
                const last12Months = sortedMonths.slice(-12);
                
                // Prepare data for chart
                const labels = last12Months.map(month => {
                    const [year, monthNum] = month.split('-');
                    const monthNames = ['Yan', 'Fev', 'Mar', 'Apr', 'May', 'Iyn', 'Iyl', 'Avg', 'Sen', 'Okt', 'Noy', 'Dek'];
                    return `${monthNames[parseInt(monthNum) - 1]} ${year}`;
                });
                
                const revenueData = last12Months.map(month => monthlyRevenue[month] || 0);
                
                // Create gradient
                const gradient = ctx.getContext('2d').createLinearGradient(0, 0, 0, 400);
                gradient.addColorStop(0, 'rgba(59, 130, 246, 0.3)');
                gradient.addColorStop(1, 'rgba(59, 130, 246, 0.05)');
                
                // Destroy existing chart
                if (revenueChart) {
                    revenueChart.destroy();
                }
                
                revenueChart = new Chart(ctx, {
                    type: "line",
                    data: {
                        labels: labels,
                        datasets: [{
                            label: "Daromad",
                            data: revenueData,
                            borderColor: "#3b82f6",
                            backgroundColor: gradient,
                            tension: 0.4,
                            fill: true,
                            borderWidth: 3,
                            pointRadius: 0,
                            pointHoverRadius: 6,
                            pointBackgroundColor: "#3b82f6",
                            pointBorderColor: "#ffffff",
                            pointBorderWidth: 2,
                            pointHoverBackgroundColor: "#2563eb",
                            pointHoverBorderColor: "#ffffff",
                            pointHoverBorderWidth: 3
                        }]
                    },
                    options: {
                        responsive: true,
                        maintainAspectRatio: false,
                        plugins: { 
                            legend: { display: false },
                            tooltip: {
                                callbacks: {
                                    label: function(context) {
                                        return new Intl.NumberFormat('uz-UZ').format(context.parsed.y) + ' so\'m';
                                    }
                                }
                            }
                        },
                        scales: {
                            y: { 
                                ticks: { 
                                    callback: function(value) {
                                        if (value >= 1000000) {
                                            return (value / 1000000).toFixed(1) + 'M';
                                        }
                                        return new Intl.NumberFormat('uz-UZ').format(value);
                                    }
                                }
                            }
                        }
                    }
                });
                
                // Update dashboard stats
                const totalRevenue = payments.reduce((sum, payment) => sum + payment.amount, 0);
                document.getElementById('totalRevenue').textContent = new Intl.NumberFormat('uz-UZ').format(totalRevenue) + ' so\'m';
                
                // Today's payments
                const today = new Date().toISOString().split('T')[0];
                const todayPayments = payments.filter(p => p.paymentDate === today)
                    .reduce((sum, payment) => sum + payment.amount, 0);
                document.getElementById('todayPayments').textContent = new Intl.NumberFormat('uz-UZ').format(todayPayments) + ' so\'m';
            };
            
            // Initialize subscription chart
            const initSubscriptionChart = () => {
                const ctx = document.getElementById('subscriptionChart');
                if (!ctx) return;
                
                const data = DataManager.getAllData();
                const schools = data.schools;
                
                // Count subscription types
                const monthlyCount = schools.filter(s => s.subscriptionType === 'monthly').length;
                const yearlyCount = schools.filter(s => s.subscriptionType === 'yearly').length;
                
                // Destroy existing chart
                if (subscriptionChart) {
                    subscriptionChart.destroy();
                }
                
                subscriptionChart = new Chart(ctx, {
                    type: "doughnut",
                    data: {
                        labels: ["Oyli obuna", "Yillik obuna"],
                        datasets: [{
                            data: [monthlyCount, yearlyCount],
                            backgroundColor: [
                                "rgba(59, 130, 246, 0.9)",
                                "rgba(16, 185, 129, 0.9)"
                            ],
                            borderColor: [
                                "#3b82f6",
                                "#10b981"
                            ],
                            borderWidth: 2
                        }]
                    },
                    options: { 
                        responsive: true,
                        maintainAspectRatio: false,
                        plugins: { 
                            legend: { 
                                position: "bottom"
                            }
                        }, 
                        cutout: "60%"
                    }
                });
                
                // Update school count
                document.getElementById('schoolsCount').textContent = schools.length;
            };
            
            // Initialize top schools chart
            const initTopSchoolsChart = () => {
                const ctx = document.getElementById('topSchoolsChart');
                if (!ctx) return;
                
                const data = DataManager.getAllData();
                const payments = data.payments;
                const schools = data.schools;
                
                // Calculate total payments per school
                const schoolPayments = {};
                payments.forEach(payment => {
                    if (!schoolPayments[payment.schoolName]) {
                        schoolPayments[payment.schoolName] = 0;
                    }
                    schoolPayments[payment.schoolName] += payment.amount;
                });
                
                // Get top 5 schools
                const topSchools = Object.entries(schoolPayments)
                    .sort((a, b) => b[1] - a[1])
                    .slice(0, 5);
                
                const labels = topSchools.map(([name]) => name);
                const paymentData = topSchools.map(([, amount]) => amount);
                
                // Create gradient
                const gradient = ctx.getContext('2d').createLinearGradient(0, 0, 0, 400);
                gradient.addColorStop(0, 'rgba(6, 182, 212, 0.9)');
                gradient.addColorStop(1, 'rgba(6, 182, 212, 0.5)');
                
                // Destroy existing chart
                if (topSchoolsChart) {
                    topSchoolsChart.destroy();
                }
                
                topSchoolsChart = new Chart(ctx, {
                    type: "bar",
                    data: {
                        labels: labels,
                        datasets: [{
                            label: "To'lovlar",
                            data: paymentData,
                            backgroundColor: gradient,
                            borderColor: "#06b6d4",
                            borderWidth: 2,
                            borderRadius: 8
                        }]
                    },
                    options: {
                        responsive: true,
                        maintainAspectRatio: false,
                        plugins: { 
                            legend: { display: false },
                            tooltip: {
                                callbacks: {
                                    label: function(context) {
                                        return new Intl.NumberFormat('uz-UZ').format(context.parsed.y) + ' so\'m';
                                    }
                                }
                            }
                        },
                        scales: {
                            y: {
                                ticks: { 
                                    callback: function(value) {
                                        if (value >= 1000000) {
                                            return (value / 1000000).toFixed(1) + 'M';
                                        }
                                        return new Intl.NumberFormat('uz-UZ').format(value);
                                    }
                                }
                            }
                        }
                    }
                });
                
                // Update user count
                document.getElementById('usersCount').textContent = data.users.length;
            };
            
            // Update all charts
            const updateCharts = () => {
                initRevenueChart();
                initSubscriptionChart();
                initTopSchoolsChart();
            };
            
            return {
                initCharts,
                updateCharts
            };
        })();

        // Form Manager Module
        const FormManager = (function() {
            // Calculate expiry date based on payment date and subscription type
            const calculateExpiryDate = (dateFieldId, subscriptionFieldId, expiryFieldId) => {
                const dateField = document.getElementById(dateFieldId);
                const subscriptionField = document.getElementById(subscriptionFieldId);
                const expiryField = document.getElementById(expiryFieldId);
                
                if (!dateField || !subscriptionField || !expiryField) return;
                
                const updateExpiryDate = () => {
                    const paymentDate = new Date(dateField.value);
                    const subscriptionType = subscriptionField.value;
                    
                    if (!isNaN(paymentDate.getTime())) {
                        const expiryDate = new Date(paymentDate);
                        
                        if (subscriptionType === 'monthly') {
                            expiryDate.setMonth(expiryDate.getMonth() + 1);
                        } else if (subscriptionType === 'yearly') {
                            expiryDate.setFullYear(expiryDate.getFullYear() + 1);
                        }
                        
                        expiryField.value = expiryDate.toISOString().split('T')[0];
                    }
                };
                
                dateField.addEventListener('change', updateExpiryDate);
                subscriptionField.addEventListener('change', updateExpiryDate);
                
                // Initial calculation
                updateExpiryDate();
            };
            
            // Initialize all forms
            const initForms = () => {
                // School form expiry calculation
                calculateExpiryDate('createSchoolPaymentDate', 'createSchoolSubscriptionType', 'createSchoolExpiryDate');
                calculateExpiryDate('editSchoolPaymentDate', 'editSchoolSubscriptionType', 'editSchoolExpiryDate');
                
                // Payment form expiry calculation
                calculateExpiryDate('createPaymentDate', 'createPaymentSubscriptionType', 'createPaymentExpiryDate');
                
                // Demo user form expiry calculation (7 days)
                const demoCreatedDate = document.getElementById('createDemoUserCreatedDate');
                const demoExpiryDate = document.getElementById('createDemoUserExpiryDate');
                
                if (demoCreatedDate && demoExpiryDate) {
                    const updateDemoExpiryDate = () => {
                        const createdDate = new Date(demoCreatedDate.value);
                        if (!isNaN(createdDate.getTime())) {
                            const expiryDate = new Date(createdDate);
                            expiryDate.setDate(expiryDate.getDate() + 7);
                            demoExpiryDate.value = expiryDate.toISOString().split('T')[0];
                        }
                    };
                    
                    demoCreatedDate.addEventListener('change', updateDemoExpiryDate);
                    updateDemoExpiryDate();
                }
                
                // User role change handler
                const userRoleField = document.getElementById('createUserRole');
                const schoolFieldContainer = document.getElementById('createUserSchoolField');
                
                if (userRoleField && schoolFieldContainer) {
                    userRoleField.addEventListener('change', function() {
                        if (this.value === 'student') {
                            schoolFieldContainer.classList.remove('hidden');
                            document.getElementById('createUserSchool').required = true;
                        } else {
                            schoolFieldContainer.classList.add('hidden');
                            document.getElementById('createUserSchool').required = false;
                        }
                    });
                }
                
                // Initialize status switches in forms
                initFormStatusSwitches();
                
                // Populate school selects
                populateSchoolSelects();
            };
            
            // Initialize status switches in forms
            const initFormStatusSwitches = () => {
                // Create school form
                const createSchoolToggle = document.getElementById('createSchoolStatusToggle');
                const createSchoolLabel = document.getElementById('createSchoolStatusLabel');
                
                if (createSchoolToggle && createSchoolLabel) {
                    createSchoolToggle.addEventListener('change', function() {
                        UIManager.updateStatusLabel(this, createSchoolLabel);
                    });
                }
                
                // Edit school form
                const editSchoolToggle = document.getElementById('editSchoolStatusToggle');
                const editSchoolLabel = document.getElementById('editSchoolStatusLabel');
                
                if (editSchoolToggle && editSchoolLabel) {
                    editSchoolToggle.addEventListener('change', function() {
                        UIManager.updateStatusLabel(this, editSchoolLabel);
                    });
                }
                
                // Create user form
                const createUserToggle = document.getElementById('createUserStatusToggle');
                const createUserLabel = document.getElementById('createUserStatusLabel');
                
                if (createUserToggle && createUserLabel) {
                    createUserToggle.addEventListener('change', function() {
                        UIManager.updateStatusLabel(this, createUserLabel);
                    });
                }
                
                // Create payment form
                const createPaymentToggle = document.getElementById('createPaymentStatusToggle');
                const createPaymentLabel = document.getElementById('createPaymentStatusLabel');
                
                if (createPaymentToggle && createPaymentLabel) {
                    createPaymentToggle.addEventListener('change', function() {
                        if (this.checked) {
                            createPaymentLabel.textContent = "To'langan";
                            createPaymentLabel.className = "status-label status-active";
                        } else {
                            createPaymentLabel.textContent = "Muddati o'tgan";
                            createPaymentLabel.className = "status-label status-blocked";
                        }
                    });
                }
            };
            
            // Populate school selects in forms
            const populateSchoolSelects = () => {
                const data = DataManager.getAllData();
                const schools = data.schools;
                
                // School select for user form
                const userSchoolSelect = document.getElementById('createUserSchool');
                if (userSchoolSelect) {
                    userSchoolSelect.innerHTML = '<option value="">Maktab tanlang</option>';
                    schools.forEach(school => {
                        const option = document.createElement('option');
                        option.value = school.id;
                        option.textContent = school.name;
                        userSchoolSelect.appendChild(option);
                    });
                }
                
                // School select for random students form
                const randomSchoolSelect = document.getElementById('randomStudentsSchool');
                if (randomSchoolSelect) {
                    randomSchoolSelect.innerHTML = '<option value="">Maktab tanlang</option>';
                    schools.forEach(school => {
                        const option = document.createElement('option');
                        option.value = school.id;
                        option.textContent = school.name;
                        randomSchoolSelect.appendChild(option);
                    });
                }
                
                // School select for payment form
                const paymentSchoolSelect = document.getElementById('createPaymentSchool');
                if (paymentSchoolSelect) {
                    paymentSchoolSelect.innerHTML = '<option value="">Maktab tanlang</option>';
                    schools.forEach(school => {
                        const option = document.createElement('option');
                        option.value = school.id;
                        option.textContent = school.name;
                        paymentSchoolSelect.appendChild(option);
                    });
                }
                
                // School filter for user table
                const userSchoolFilter = document.getElementById('userSchoolFilter');
                if (userSchoolFilter) {
                    userSchoolFilter.innerHTML = '<option value="">Barcha maktablar</option>';
                    schools.forEach(school => {
                        const option = document.createElement('option');
                        option.value = school.id;
                        option.textContent = school.name;
                        userSchoolFilter.appendChild(option);
                    });
                }
                
                // School filter for payment table
                const paymentSchoolFilter = document.getElementById('paymentSchoolFilter');
                if (paymentSchoolFilter) {
                    paymentSchoolFilter.innerHTML = '<option value="">Barcha maktablar</option>';
                    schools.forEach(school => {
                        const option = document.createElement('option');
                        option.value = school.id;
                        option.textContent = school.name;
                        paymentSchoolFilter.appendChild(option);
                    });
                }
            };
            
            // Handle create school form submission
            const handleCreateSchoolForm = () => {
                const form = document.getElementById('createSchoolForm');
                if (!form) return;
                
                form.addEventListener('submit', function(e) {
                    e.preventDefault();
                    
                    const newSchool = {
                        id: DataManager.getNextId('schools'),
                        name: document.getElementById('createSchoolName').value.trim(),
                        phone: document.getElementById('createSchoolPhone').value.trim(),
                        paymentDate: document.getElementById('createSchoolPaymentDate').value,
                        expiryDate: document.getElementById('createSchoolExpiryDate').value,
                        subscriptionType: document.getElementById('createSchoolSubscriptionType').value,
                        status: document.getElementById('createSchoolStatusToggle').checked ? 'active' : 'blocked',
                        createdAt: new Date().toISOString().split('T')[0]
                    };
                    
                    DataManager.addItem('schools', newSchool);
                    
                    // Close modal
                    document.getElementById('createSchoolOverlay').classList.add('hidden');
                    form.reset();
                    
                    // Update UI
                    TableManager.renderSchoolsTable();
                    ChartManager.updateCharts();
                    TableManager.renderExpiringSoonList();
                    populateSchoolSelects();
                    
                    UIManager.showToast('Yangi maktab muvaffaqiyatli yaratildi', 'success');
                });
            };
            
            // Handle edit school form submission
            const handleEditSchoolForm = () => {
                const form = document.getElementById('editSchoolForm');
                if (!form) return;
                
                form.addEventListener('submit', function(e) {
                    e.preventDefault();
                    
                    const schoolId = document.getElementById('editSchoolId').value;
                    const updates = {
                        name: document.getElementById('editSchoolName').value.trim(),
                        phone: document.getElementById('editSchoolPhone').value.trim(),
                        paymentDate: document.getElementById('editSchoolPaymentDate').value,
                        expiryDate: document.getElementById('editSchoolExpiryDate').value,
                        subscriptionType: document.getElementById('editSchoolSubscriptionType').value,
                        status: document.getElementById('editSchoolStatusToggle').checked ? 'active' : 'blocked'
                    };
                    
                    DataManager.updateItem('schools', schoolId, updates);
                    
                    // Close modal
                    document.getElementById('editSchoolOverlay').classList.add('hidden');
                    form.reset();
                    
                    // Update UI
                    TableManager.renderSchoolsTable();
                    ChartManager.updateCharts();
                    TableManager.renderExpiringSoonList();
                    
                    UIManager.showToast('Maktab ma\'lumotlari muvaffaqiyatli yangilandi', 'success');
                });
            };
            
            // Handle create user form submission
            const handleCreateUserForm = () => {
                const form = document.getElementById('createUserForm');
                if (!form) return;
                
                form.addEventListener('submit', function(e) {
                    e.preventDefault();
                    
                    const role = document.getElementById('createUserRole').value;
                    const schoolId = role === 'student' ? document.getElementById('createUserSchool').value : null;
                    const schools = DataManager.getAllData().schools;
                    const school = schools.find(s => s.id == schoolId);
                    
                    const newUser = {
                        id: DataManager.getNextId('users'),
                        name: document.getElementById('createUserName').value.trim(),
                        phone: document.getElementById('createUserPhone').value.trim(),
                        password: document.getElementById('createUserPassword').value.trim(),
                        role: role,
                        schoolId: schoolId ? parseInt(schoolId) : null,
                        schoolName: school ? school.name : null,
                        status: document.getElementById('createUserStatusToggle').checked ? 'active' : 'blocked',
                        createdAt: new Date().toISOString().split('T')[0]
                    };
                    
                    DataManager.addItem('users', newUser);
                    
                    // Close modal
                    document.getElementById('createUserOverlay').classList.add('hidden');
                    form.reset();
                    
                    // Update UI
                    TableManager.renderUsersTable();
                    ChartManager.updateCharts();
                    
                    UIManager.showToast('Yangi foydalanuvchi muvaffaqiyatli yaratildi', 'success');
                });
            };
            
            // Handle random students form submission
            const handleRandomStudentsForm = () => {
                const form = document.getElementById('randomStudentsForm');
                if (!form) return;
                
                form.addEventListener('submit', function(e) {
                    e.preventDefault();
                    
                    const schoolId = document.getElementById('randomStudentsSchool').value;
                    const count = parseInt(document.getElementById('randomStudentsCount').value);
                    const password = document.getElementById('randomStudentsPassword').value.trim();
                    
                    if (!schoolId || count < 1 || count > 100) {
                        UIManager.showToast('Iltimos, barcha maydonlarni to\'g\'ri to\'ldiring', 'error');
                        return;
                    }
                    
                    const newStudents = DataManager.generateRandomStudents(schoolId, count, password);
                    
                    // Close modal
                    document.getElementById('randomStudentsOverlay').classList.add('hidden');
                    form.reset();
                    
                    // Update UI
                    TableManager.renderUsersTable();
                    ChartManager.updateCharts();
                    
                    UIManager.showToast(`${count} ta random student muvaffaqiyatli yaratildi`, 'success');
                });
            };
            
            // Handle create payment form submission
            const handleCreatePaymentForm = () => {
                const form = document.getElementById('createPaymentForm');
                if (!form) return;
                
                form.addEventListener('submit', function(e) {
                    e.preventDefault();
                    
                    const schoolId = document.getElementById('createPaymentSchool').value;
                    const schools = DataManager.getAllData().schools;
                    const school = schools.find(s => s.id == schoolId);
                    
                    if (!school) {
                        UIManager.showToast('Iltimos, maktabni tanlang', 'error');
                        return;
                    }
                    
                    const newPayment = {
                        id: DataManager.getNextId('payments'),
                        schoolId: parseInt(schoolId),
                        schoolName: school.name,
                        amount: parseInt(document.getElementById('createPaymentAmount').value),
                        paymentDate: document.getElementById('createPaymentDate').value,
                        expiryDate: document.getElementById('createPaymentExpiryDate').value,
                        subscriptionType: document.getElementById('createPaymentSubscriptionType').value,
                        status: document.getElementById('createPaymentStatusToggle').checked ? 'paid' : 'overdue',
                        createdAt: new Date().toISOString().split('T')[0]
                    };
                    
                    DataManager.addItem('payments', newPayment);
                    
                    // Also update the school's payment and expiry dates
                    DataManager.updateItem('schools', schoolId, {
                        paymentDate: newPayment.paymentDate,
                        expiryDate: newPayment.expiryDate,
                        subscriptionType: newPayment.subscriptionType,
                        status: 'active'
                    });
                    
                    // Close modal
                    document.getElementById('createPaymentOverlay').classList.add('hidden');
                    form.reset();
                    
                    // Update UI
                    TableManager.renderPaymentsTable();
                    TableManager.renderSchoolsTable();
                    ChartManager.updateCharts();
                    TableManager.renderExpiringSoonList();
                    
                    UIManager.showToast('Yangi to\'lov muvaffaqiyatli yaratildi', 'success');
                });
            };
            
            // Handle create demo user form submission
            const handleCreateDemoUserForm = () => {
                const form = document.getElementById('createDemoUserForm');
                if (!form) return;
                
                form.addEventListener('submit', function(e) {
                    e.preventDefault();
                    
                    const newDemoUser = {
                        id: DataManager.getNextId('demoUsers'),
                        name: document.getElementById('createDemoUserName').value.trim(),
                        phone: document.getElementById('createDemoUserPhone').value.trim(),
                        password: document.getElementById('createDemoUserPassword').value.trim(),
                        createdDate: document.getElementById('createDemoUserCreatedDate').value,
                        expiryDate: document.getElementById('createDemoUserExpiryDate').value,
                        status: 'active',
                        daysLeft: 7
                    };
                    
                    DataManager.addItem('demoUsers', newDemoUser);
                    
                    // Close modal
                    document.getElementById('createDemoUserOverlay').classList.add('hidden');
                    form.reset();
                    
                    // Update UI
                    TableManager.renderDemoUsersTable();
                    
                    UIManager.showToast('Yangi demo foydalanuvchi muvaffaqiyatli yaratildi', 'success');
                });
            };
            
            // Handle profile settings form submission
            const handleProfileSettingsForm = () => {
                const form = document.getElementById('profileSettingsForm');
                if (!form) return;
                
                form.addEventListener('submit', function(e) {
                    e.preventDefault();
                    
                    const profileData = {
                        name: document.getElementById('profileNameInput').value.trim(),
                        phone: document.getElementById('profilePhoneInput').value.trim()
                    };
                    
                    DataManager.saveData('profile', profileData);
                    
                    // Update UI
                    document.getElementById('profileName').textContent = profileData.name;
                    
                    // Close modal
                    document.getElementById('profileSettingsOverlay').classList.add('hidden');
                    form.reset();
                    
                    UIManager.showToast('Profil ma\'lumotlari muvaffaqiyatli yangilandi', 'success');
                });
            };
            
            return {
                initForms,
                handleCreateSchoolForm,
                handleEditSchoolForm,
                handleCreateUserForm,
                handleRandomStudentsForm,
                handleCreatePaymentForm,
                handleCreateDemoUserForm,
                handleProfileSettingsForm,
                calculateExpiryDate
            };
        })();

        // Filter Manager Module
        const FilterManager = (function() {
            // Apply filters to schools table
            const applySchoolFilters = () => {
                const data = DataManager.getAllData();
                let filteredSchools = [...data.schools];
                
                // Search filter
                const searchTerm = document.getElementById('schoolSearch').value.toLowerCase();
                if (searchTerm) {
                    filteredSchools = filteredSchools.filter(school => 
                        school.name.toLowerCase().includes(searchTerm) ||
                        school.phone.toLowerCase().includes(searchTerm)
                    );
                }
                
                // Status filter
                const statusFilter = document.getElementById('schoolStatusFilter').value;
                if (statusFilter) {
                    filteredSchools = filteredSchools.filter(school => school.status === statusFilter);
                }
                
                // Subscription filter
                const subscriptionFilter = document.getElementById('schoolSubscriptionFilter').value;
                if (subscriptionFilter) {
                    filteredSchools = filteredSchools.filter(school => school.subscriptionType === subscriptionFilter);
                }
                
                // Date filter
                const dateFilter = document.getElementById('schoolDateFilter').value;
                if (dateFilter) {
                    filteredSchools = filteredSchools.filter(school => school.paymentDate === dateFilter);
                }
                
                TableManager.renderSchoolsTable(filteredSchools);
            };
            
            // Apply filters to users table
            const applyUserFilters = () => {
                const data = DataManager.getAllData();
                let filteredUsers = [...data.users];
                
                // Search filter
                const searchTerm = document.getElementById('userSearch').value.toLowerCase();
                if (searchTerm) {
                    filteredUsers = filteredUsers.filter(user => 
                        user.name.toLowerCase().includes(searchTerm) ||
                        user.phone.toLowerCase().includes(searchTerm) ||
                        user.schoolName?.toLowerCase().includes(searchTerm)
                    );
                }
                
                // Role filter
                const roleFilter = document.getElementById('userRoleFilter').value;
                if (roleFilter) {
                    filteredUsers = filteredUsers.filter(user => user.role === roleFilter);
                }
                
                // Status filter
                const statusFilter = document.getElementById('userStatusFilter').value;
                if (statusFilter) {
                    filteredUsers = filteredUsers.filter(user => user.status === statusFilter);
                }
                
                // School filter
                const schoolFilter = document.getElementById('userSchoolFilter').value;
                if (schoolFilter) {
                    filteredUsers = filteredUsers.filter(user => user.schoolId == schoolFilter);
                }
                
                TableManager.renderUsersTable(filteredUsers);
            };
            
            // Apply filters to payments table
            const applyPaymentFilters = () => {
                const data = DataManager.getAllData();
                let filteredPayments = [...data.payments];
                
                // Search filter
                const searchTerm = document.getElementById('paymentSearch').value.toLowerCase();
                if (searchTerm) {
                    filteredPayments = filteredPayments.filter(payment => 
                        payment.schoolName.toLowerCase().includes(searchTerm)
                    );
                }
                
                // Status filter
                const statusFilter = document.getElementById('paymentStatusFilter').value;
                if (statusFilter) {
                    filteredPayments = filteredPayments.filter(payment => payment.status === statusFilter);
                }
                
                // Subscription filter
                const subscriptionFilter = document.getElementById('paymentSubscriptionFilter').value;
                if (subscriptionFilter) {
                    filteredPayments = filteredPayments.filter(payment => payment.subscriptionType === subscriptionFilter);
                }
                
                // School filter
                const schoolFilter = document.getElementById('paymentSchoolFilter').value;
                if (schoolFilter) {
                    filteredPayments = filteredPayments.filter(payment => payment.schoolId == schoolFilter);
                }
                
                // Date range filter
                const dateFrom = document.getElementById('paymentDateFrom').value;
                const dateTo = document.getElementById('paymentDateTo').value;
                
                if (dateFrom) {
                    filteredPayments = filteredPayments.filter(payment => payment.paymentDate >= dateFrom);
                }
                
                if (dateTo) {
                    filteredPayments = filteredPayments.filter(payment => payment.paymentDate <= dateTo);
                }
                
                TableManager.renderPaymentsTable(filteredPayments);
            };
            
            // Apply filters to demo users table
            const applyDemoUserFilters = () => {
                const data = DataManager.getAllData();
                let filteredDemoUsers = [...data.demoUsers];
                
                // Search filter
                const searchTerm = document.getElementById('demoUserSearch').value.toLowerCase();
                if (searchTerm) {
                    filteredDemoUsers = filteredDemoUsers.filter(demoUser => 
                        demoUser.name.toLowerCase().includes(searchTerm) ||
                        demoUser.phone.toLowerCase().includes(searchTerm)
                    );
                }
                
                TableManager.renderDemoUsersTable(filteredDemoUsers);
            };
            
            // Initialize filters
            const initFilters = () => {
                // School filters
                document.getElementById('schoolSearch').addEventListener('input', applySchoolFilters);
                document.getElementById('schoolStatusFilter').addEventListener('change', applySchoolFilters);
                document.getElementById('schoolSubscriptionFilter').addEventListener('change', applySchoolFilters);
                document.getElementById('schoolDateFilter').addEventListener('change', applySchoolFilters);
                document.getElementById('clearSchoolFilters').addEventListener('click', () => {
                    document.getElementById('schoolSearch').value = '';
                    document.getElementById('schoolStatusFilter').value = '';
                    document.getElementById('schoolSubscriptionFilter').value = '';
                    document.getElementById('schoolDateFilter').value = '';
                    applySchoolFilters();
                });
                
                // User filters
                document.getElementById('userSearch').addEventListener('input', applyUserFilters);
                document.getElementById('userRoleFilter').addEventListener('change', applyUserFilters);
                document.getElementById('userStatusFilter').addEventListener('change', applyUserFilters);
                document.getElementById('userSchoolFilter').addEventListener('change', applyUserFilters);
                document.getElementById('clearUserFilters').addEventListener('click', () => {
                    document.getElementById('userSearch').value = '';
                    document.getElementById('userRoleFilter').value = '';
                    document.getElementById('userStatusFilter').value = '';
                    document.getElementById('userSchoolFilter').value = '';
                    applyUserFilters();
                });
                
                // Payment filters
                document.getElementById('paymentSearch').addEventListener('input', applyPaymentFilters);
                document.getElementById('paymentStatusFilter').addEventListener('change', applyPaymentFilters);
                document.getElementById('paymentSubscriptionFilter').addEventListener('change', applyPaymentFilters);
                document.getElementById('paymentSchoolFilter').addEventListener('change', applyPaymentFilters);
                document.getElementById('paymentDateFrom').addEventListener('change', applyPaymentFilters);
                document.getElementById('paymentDateTo').addEventListener('change', applyPaymentFilters);
                document.getElementById('clearPaymentFilters').addEventListener('click', () => {
                    document.getElementById('paymentSearch').value = '';
                    document.getElementById('paymentStatusFilter').value = '';
                    document.getElementById('paymentSubscriptionFilter').value = '';
                    document.getElementById('paymentSchoolFilter').value = '';
                    document.getElementById('paymentDateFrom').value = '';
                    document.getElementById('paymentDateTo').value = '';
                    applyPaymentFilters();
                });
                
                // Demo user filters
                document.getElementById('demoUserSearch').addEventListener('input', applyDemoUserFilters);
                
                // Expiring days filter
                document.getElementById('expiringDaysFilter').addEventListener('change', () => {
                    TableManager.renderExpiringSoonList();
                });
            };
            
            return {
                initFilters,
                applySchoolFilters,
                applyUserFilters,
                applyPaymentFilters,
                applyDemoUserFilters
            };
        })();

        // Pagination Manager Module
        const PaginationManager = (function() {
            // Initialize pagination
            const initPagination = () => {
                // School pagination
                document.getElementById('schoolPrevPage').addEventListener('click', () => {
                    if (TableManager.currentPage.schools > 1) {
                        TableManager.currentPage.schools--;
                        TableManager.renderSchoolsTable();
                    }
                });
                
                document.getElementById('schoolNextPage').addEventListener('click', () => {
                    TableManager.currentPage.schools++;
                    TableManager.renderSchoolsTable();
                });
                
                document.getElementById('schoolPageSize').addEventListener('change', function() {
                    TableManager.pageSize.schools = parseInt(this.value);
                    TableManager.currentPage.schools = 1;
                    TableManager.renderSchoolsTable();
                });
                
                // User pagination
                document.getElementById('userPrevPage').addEventListener('click', () => {
                    if (TableManager.currentPage.users > 1) {
                        TableManager.currentPage.users--;
                        TableManager.renderUsersTable();
                    }
                });
                
                document.getElementById('userNextPage').addEventListener('click', () => {
                    TableManager.currentPage.users++;
                    TableManager.renderUsersTable();
                });
                
                document.getElementById('userPageSize').addEventListener('change', function() {
                    TableManager.pageSize.users = parseInt(this.value);
                    TableManager.currentPage.users = 1;
                    TableManager.renderUsersTable();
                });
                
                // Payment pagination
                document.getElementById('paymentPrevPage').addEventListener('click', () => {
                    if (TableManager.currentPage.payments > 1) {
                        TableManager.currentPage.payments--;
                        TableManager.renderPaymentsTable();
                    }
                });
                
                document.getElementById('paymentNextPage').addEventListener('click', () => {
                    TableManager.currentPage.payments++;
                    TableManager.renderPaymentsTable();
                });
                
                document.getElementById('paymentPageSize').addEventListener('change', function() {
                    TableManager.pageSize.payments = parseInt(this.value);
                    TableManager.currentPage.payments = 1;
                    TableManager.renderPaymentsTable();
                });
                
                // Demo user pagination
                document.getElementById('demoUserPrevPage').addEventListener('click', () => {
                    if (TableManager.currentPage.demoUsers > 1) {
                        TableManager.currentPage.demoUsers--;
                        TableManager.renderDemoUsersTable();
                    }
                });
                
                document.getElementById('demoUserNextPage').addEventListener('click', () => {
                    TableManager.currentPage.demoUsers++;
                    TableManager.renderDemoUsersTable();
                });
                
                document.getElementById('demoUserPageSize').addEventListener('change', function() {
                    TableManager.pageSize.demoUsers = parseInt(this.value);
                    TableManager.currentPage.demoUsers = 1;
                    TableManager.renderDemoUsersTable();
                });
            };
            
            return {
                initPagination
            };
        })();

        // Sort Manager Module
        const SortManager = (function() {
            // Initialize sorting
            const initSorting = () => {
                // Add click event to all sort headers
                document.querySelectorAll('.sort-header').forEach(header => {
                    header.addEventListener('click', function() {
                        const tableType = this.closest('table').parentElement.parentElement.id.replace('TableBody', '').replace('schools', 'schools').replace('users', 'users').replace('payments', 'payments').replace('demoUsers', 'demoUsers');
                        const field = this.getAttribute('data-sort');
                        
                        // Update sort config
                        if (TableManager.sortConfig[tableType].field === field) {
                            // Toggle direction
                            TableManager.sortConfig[tableType].direction = 
                                TableManager.sortConfig[tableType].direction === 'asc' ? 'desc' : 'asc';
                        } else {
                            // New field, default to ascending
                            TableManager.sortConfig[tableType].field = field;
                            TableManager.sortConfig[tableType].direction = 'asc';
                        }
                        
                        // Update sort icons
                        updateSortIcons(this, tableType);
                        
                        // Re-render table
                        switch(tableType) {
                            case 'schools':
                                TableManager.renderSchoolsTable();
                                break;
                            case 'users':
                                TableManager.renderUsersTable();
                                break;
                            case 'payments':
                                TableManager.renderPaymentsTable();
                                break;
                            case 'demoUsers':
                                TableManager.renderDemoUsersTable();
                                break;
                        }
                    });
                });
            };
            
            // Update sort icons
            const updateSortIcons = (clickedHeader, tableType) => {
                // Reset all icons in this table
                const table = clickedHeader.closest('table');
                table.querySelectorAll('.sort-header i').forEach(icon => {
                    icon.className = 'fas fa-sort ml-1';
                });
                
                // Set icon for clicked header
                const icon = clickedHeader.querySelector('i');
                if (TableManager.sortConfig[tableType].direction === 'asc') {
                    icon.className = 'fas fa-sort-up ml-1';
                } else {
                    icon.className = 'fas fa-sort-down ml-1';
                }
            };
            
            return {
                initSorting
            };
        })();

        // Main Application Initialization
        document.addEventListener("DOMContentLoaded", () => {
            // Initialize data
            DataManager.initializeData();
            
            // Initialize UI components
            UIManager.initStatusSwitches();
            
            // Initialize forms
            FormManager.initForms();
            FormManager.handleCreateSchoolForm();
            FormManager.handleEditSchoolForm();
            FormManager.handleCreateUserForm();
            FormManager.handleRandomStudentsForm();
            FormManager.handleCreatePaymentForm();
            FormManager.handleCreateDemoUserForm();
            FormManager.handleProfileSettingsForm();
            
            // Initialize filters
            FilterManager.initFilters();
            
            // Initialize pagination
            PaginationManager.initPagination();
            
            // Initialize sorting
            SortManager.initSorting();
            
            // Initialize charts
            ChartManager.initCharts();
            
            // Render tables
            TableManager.renderSchoolsTable();
            TableManager.renderUsersTable();
            TableManager.renderPaymentsTable();
            TableManager.renderDemoUsersTable();
            TableManager.renderExpiringSoonList();
            
            // Check for expired items
            const expiringCount = DataManager.checkExpiries();
            document.getElementById('expiringCount').textContent = expiringCount;
            
            // Check for expired items periodically (every minute)
            setInterval(() => {
                const newExpiringCount = DataManager.checkExpiries();
                document.getElementById('expiringCount').textContent = newExpiringCount;
                TableManager.renderExpiringSoonList();
                TableManager.renderSchoolsTable();
                TableManager.renderDemoUsersTable();
            }, 60000);
            
            // Mobile menu functionality
            const sidebar = document.getElementById("sidebar");
            const sidebarOverlay = document.getElementById("sidebarOverlay");
            const mobileMenuBtn = document.getElementById("mobileMenuBtn");
            const mobileCloseBtn = document.getElementById("mobileCloseBtn");
            
            function openMobileMenu() {
                sidebar.classList.add("mobile-open");
                sidebarOverlay.classList.add("active");
                document.body.style.overflow = "hidden";
            }
            
            function closeMobileMenu() {
                sidebar.classList.remove("mobile-open");
                sidebarOverlay.classList.remove("active");
                document.body.style.overflow = "";
            }
            
            if (mobileMenuBtn) {
                mobileMenuBtn.addEventListener("click", openMobileMenu);
            }
            
            if (mobileCloseBtn) {
                mobileCloseBtn.addEventListener("click", closeMobileMenu);
            }
            
            if (sidebarOverlay) {
                sidebarOverlay.addEventListener("click", closeMobileMenu);
            }
            
            // Phone number validation
            function validatePhoneInput(input) {
                input.addEventListener('input', function(e) {
                    let value = e.target.value;
                    if (value.startsWith('+')) {
                        value = '+' + value.slice(1).replace(/[^0-9]/g, '');
                    } else {
                        value = value.replace(/[^0-9]/g, '');
                    }
                    e.target.value = value;
                });
                
                input.addEventListener('paste', function(e) {
                    e.preventDefault();
                    let paste = (e.clipboardData || window.clipboardData).getData('text');
                    if (paste.startsWith('+')) {
                        paste = '+' + paste.slice(1).replace(/[^0-9]/g, '');
                    } else {
                        paste = paste.replace(/[^0-9]/g, '');
                    }
                    this.value = paste;
                });
            }
            
            // Apply phone validation to all phone input fields
            const phoneInputs = document.querySelectorAll('input[type="tel"]');
            phoneInputs.forEach(input => validatePhoneInput(input));
            
            // Sidebar navigation
            const sidebarNav = document.getElementById("sidebarNav");
            const contentSections = document.querySelectorAll(".section-block");
            const breadcrumb = document.getElementById("breadcrumb");
            const pageTitle = document.getElementById("pageTitle");
            
            const sectionTitles = {
                'dashboardSection': { breadcrumb: 'Bosh sahifa', title: 'Admin Dashboard' },
                'schoolsSection': { breadcrumb: 'Bosh sahifa / Maktablar', title: 'Maktablar boshqaruvi' },
                'usersSection': { breadcrumb: 'Bosh sahifa / Foydalanuvchilar', title: 'Foydalanuvchilar boshqaruvi' },
                'paymentsSection': { breadcrumb: 'Bosh sahifa / To\'lovlar', title: 'To\'lovlar boshqaruvi' },
                'demoUsersSection': { breadcrumb: 'Bosh sahifa / Demo foydalanuvchilar', title: 'Demo foydalanuvchilar boshqaruvi' },
                'expiringSection': { breadcrumb: 'Bosh sahifa / Muddat tugash', title: 'Muddat tugash arifasidagi maktablar' }
            };
            
            if (sidebarNav) {
                sidebarNav.querySelectorAll("[data-target]").forEach((link) => {
                    link.addEventListener("click", (e) => {
                        e.preventDefault();
                        const targetId = link.getAttribute("data-target");
                        const section = document.getElementById(targetId);
                        
                        if (section) {
                            // Update breadcrumb and title
                            if (sectionTitles[targetId]) {
                                breadcrumb.textContent = sectionTitles[targetId].breadcrumb;
                                pageTitle.textContent = sectionTitles[targetId].title;
                            }
                            
                            // Show selected section, hide others
                            contentSections.forEach((el) => {
                                el.classList.toggle("hidden", el.id !== targetId);
                            });
                            
                            // Update sidebar navigation
                            sidebarNav.querySelectorAll("a").forEach((a) => {
                                a.classList.remove("bg-blue-600", "text-white", "font-semibold");
                                a.classList.add("text-gray-700", "hover:bg-gray-100");
                            });
                            link.classList.add("bg-blue-600", "text-white", "font-semibold");
                            link.classList.remove("text-gray-700", "hover:bg-gray-100");
                            
                            // Close mobile menu
                            if (window.innerWidth < 768) {
                                closeMobileMenu();
                            }
                        }
                    });
                });
            }
            
            // Close mobile menu on window resize
            window.addEventListener("resize", () => {
                if (window.innerWidth >= 768) {
                    closeMobileMenu();
                }
            });
            
            // Modal open/close handlers
            // Create School Modal
            document.getElementById("openCreateSchoolBtn")?.addEventListener("click", () => {
                document.getElementById("createSchoolOverlay").classList.remove("hidden");
                document.getElementById("createSchoolOverlay").classList.add("flex");
                
                // Set default date to today
                const today = new Date().toISOString().split('T')[0];
                document.getElementById("createSchoolPaymentDate").value = today;
                FormManager.calculateExpiryDate('createSchoolPaymentDate', 'createSchoolSubscriptionType', 'createSchoolExpiryDate');
            });
            
            document.getElementById("closeCreateSchool")?.addEventListener("click", () => {
                document.getElementById("createSchoolOverlay").classList.add("hidden");
                document.getElementById("createSchoolForm").reset();
            });
            
            document.getElementById("cancelCreateSchool")?.addEventListener("click", () => {
                document.getElementById("createSchoolOverlay").classList.add("hidden");
                document.getElementById("createSchoolForm").reset();
            });
            
            // Edit School Modal close handlers
            document.getElementById("closeEditSchool")?.addEventListener("click", () => {
                document.getElementById("editSchoolOverlay").classList.add("hidden");
                document.getElementById("editSchoolForm").reset();
            });
            
            document.getElementById("cancelEditSchool")?.addEventListener("click", () => {
                document.getElementById("editSchoolOverlay").classList.add("hidden");
                document.getElementById("editSchoolForm").reset();
            });
            
            // School Details Modal close handlers
            document.getElementById("closeSchoolDetails")?.addEventListener("click", () => {
                document.getElementById("schoolDetailsOverlay").classList.add("hidden");
            });
            
            document.getElementById("closeSchoolDetailsBtn")?.addEventListener("click", () => {
                document.getElementById("schoolDetailsOverlay").classList.add("hidden");
            });
            
            // Create User Modal
            document.getElementById("openCreateUserBtn")?.addEventListener("click", () => {
                document.getElementById("createUserOverlay").classList.remove("hidden");
                document.getElementById("createUserOverlay").classList.add("flex");
            });
            
            document.getElementById("closeCreateUser")?.addEventListener("click", () => {
                document.getElementById("createUserOverlay").classList.add("hidden");
                document.getElementById("createUserForm").reset();
            });
            
            document.getElementById("cancelCreateUser")?.addEventListener("click", () => {
                document.getElementById("createUserOverlay").classList.add("hidden");
                document.getElementById("createUserForm").reset();
            });
            
            // Random Students Modal
            document.getElementById("openRandomStudentsBtn")?.addEventListener("click", () => {
                document.getElementById("randomStudentsOverlay").classList.remove("hidden");
                document.getElementById("randomStudentsOverlay").classList.add("flex");
            });
            
            document.getElementById("closeRandomStudents")?.addEventListener("click", () => {
                document.getElementById("randomStudentsOverlay").classList.add("hidden");
                document.getElementById("randomStudentsForm").reset();
            });
            
            document.getElementById("cancelRandomStudents")?.addEventListener("click", () => {
                document.getElementById("randomStudentsOverlay").classList.add("hidden");
                document.getElementById("randomStudentsForm").reset();
            });
            
            // Create Payment Modal
            document.getElementById("openCreatePaymentBtn")?.addEventListener("click", () => {
                FormManager.openCreatePaymentModal();
            });
            
            document.getElementById("closeCreatePayment")?.addEventListener("click", () => {
                document.getElementById("createPaymentOverlay").classList.add("hidden");
                document.getElementById("createPaymentForm").reset();
            });
            
            document.getElementById("cancelCreatePayment")?.addEventListener("click", () => {
                document.getElementById("createPaymentOverlay").classList.add("hidden");
                document.getElementById("createPaymentForm").reset();
            });
            
            // Create Demo User Modal
            document.getElementById("openCreateDemoUserBtn")?.addEventListener("click", () => {
                document.getElementById("createDemoUserOverlay").classList.remove("hidden");
                document.getElementById("createDemoUserOverlay").classList.add("flex");
                
                // Set default date to today
                const today = new Date().toISOString().split('T')[0];
                document.getElementById("createDemoUserCreatedDate").value = today;
                
                // Trigger expiry date calculation
                const event = new Event('change');
                document.getElementById("createDemoUserCreatedDate").dispatchEvent(event);
            });
            
            document.getElementById("closeCreateDemoUser")?.addEventListener("click", () => {
                document.getElementById("createDemoUserOverlay").classList.add("hidden");
                document.getElementById("createDemoUserForm").reset();
            });
            
            document.getElementById("cancelCreateDemoUser")?.addEventListener("click", () => {
                document.getElementById("createDemoUserOverlay").classList.add("hidden");
                document.getElementById("createDemoUserForm").reset();
            });
            
            // Profile Settings Modal
            document.getElementById("openProfileSettings")?.addEventListener("click", () => {
                const profileData = DataManager.getAllData().profile;
                document.getElementById("profileNameInput").value = profileData.name || "";
                document.getElementById("profilePhoneInput").value = profileData.phone || "";
                
                document.getElementById("profileSettingsOverlay").classList.remove("hidden");
                document.getElementById("profileSettingsOverlay").classList.add("flex");
            });
            
            document.getElementById("closeProfileSettings")?.addEventListener("click", () => {
                document.getElementById("profileSettingsOverlay").classList.add("hidden");
                document.getElementById("profileSettingsForm").reset();
            });
            
            document.getElementById("cancelProfileSettings")?.addEventListener("click", () => {
                document.getElementById("profileSettingsOverlay").classList.add("hidden");
                document.getElementById("profileSettingsForm").reset();
            });
            
            // Confirmation Modal close handler
            document.getElementById("closeConfirmation")?.addEventListener("click", () => {
                document.getElementById("confirmationOverlay").classList.add("hidden");
            });
            
            document.getElementById("cancelConfirmation")?.addEventListener("click", () => {
                document.getElementById("confirmationOverlay").classList.add("hidden");
            });
            
            // Send reminders button
            document.getElementById("sendRemindersBtn")?.addEventListener("click", () => {
                UIManager.showToast("Barcha maktablarga eslatma xabarlari yuborildi", "success");
            });
            
            // Logout button
            document.getElementById("logoutBtn")?.addEventListener("click", () => {
                UIManager.showConfirmation(
                    "Chiqish",
                    "Haqiqatan ham tizimdan chiqmoqchimisiz?",
                    () => {
                        UIManager.showToast("Tizimdan muvaffaqiyatli chiqildi", "success");
                        // In a real app, you would redirect to login page
                        // window.location.href = "/login";
                    }
                );
            });
            
            // Initialize with dashboard
            document.querySelector('[data-target="dashboardSection"]').click();
        });
    </script>
</body>
</html>